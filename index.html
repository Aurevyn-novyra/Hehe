<!doctype html>

<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Will you be my universe?</title>
<style>
  /* ---------- Reset & base ---------- */
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;width:100%;background:#000;overflow:hidden;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
  #app{position:relative;width:100%;height:100vh;overflow:hidden;touch-action:none}

/* canvases */
canvas{position:absolute;inset:0;width:100%;height:100%;display:block;-webkit-user-select:none;user-select:none}

/* fog / film overlay */
.fog{position:absolute;inset:0;pointer-events:none;z-index:6;
background:
radial-gradient(ellipse at 22% 20%, rgba(160,100,240,0.10), transparent 14%),
radial-gradient(ellipse at 78% 86%, rgba(200,80,160,0.06), transparent 18%),
linear-gradient(180deg, rgba(10,3,18,0.24), rgba(0,0,0,0.45));
filter:blur(30px) saturate(120%);
mix-blend-mode:screen;
transform:scale(1.03);
}

/* UI container */
.ui{position:relative;z-index:10;pointer-events:none;height:100%;display:flex;align-items:center;justify-content:center;flex-direction:column;padding:24px;text-align:center;color:#efeef8}

.introText{
font-size:clamp(18px,3.6vw,30px);
line-height:1.05;
margin-bottom:18px;
color:#f3edf9;
text-shadow:0 10px 40px rgba(8,3,16,0.9);
opacity:0;transform:translateY(10px);
transition:opacity .9s cubic-bezier(.2,.9,.2,1), transform .9s cubic-bezier(.2,.9,.2,1);
pointer-events:none;
}

/* Main buttons */
.mysteryButton{
pointer-events:auto;
-webkit-tap-highlight-color:transparent;
background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.01));
border:1px solid rgba(255,255,255,0.08);
padding: clamp(12px,2.2vw,18px) clamp(20px,6vw,34px);
border-radius:28px;
color:#fff;
font-size:clamp(16px,2.8vw,20px);
cursor:pointer;
box-shadow: 0 20px 70px rgba(120,50,200,0.25), inset 0 -6px 16px rgba(255,255,255,0.02);
transition: transform .22s cubic-bezier(.2,.9,.2,1), box-shadow .22s;
user-select:none;
touch-action:manipulation;
}
.mysteryButton:active{transform:scale(.98)}
.pulse{animation:pulseGlow 2.2s infinite ease-in-out}
@keyframes pulseGlow{
0%{box-shadow:0 10px 28px rgba(120,60,200,0.18);transform:translateY(0) scale(1)}
50%{box-shadow:0 30px 80px rgba(120,60,200,0.30);transform:translateY(-6px) scale(1.03)}
100%{box-shadow:0 10px 28px rgba(120,60,200,0.18);transform:translateY(0) scale(1)}
}

/* small control row */
.controlRow{display:flex;gap:12px;align-items:center;justify-content:center;margin-top:18px;pointer-events:auto}

.btn{pointer-events:auto;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.06);padding:12px 22px;border-radius:14px;color:#fff;font-size:16px;cursor:pointer;min-width:120px;box-shadow:0 8px 28px rgba(0,0,0,0.5);transition:transform .12s}
.btn:active{transform:translateY(2px) scale(.995)}
.bigAction{font-size:18px;padding:14px 28px;border-radius:24px;min-width:160px}

/* poem display */
.poemBox{margin-top:18px;pointer-events:none;max-width:820px;margin-left:auto;margin-right:auto;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));border-radius:14px;padding:18px 22px;box-shadow:0 18px 50px rgba(40,10,60,0.33);backdrop-filter:blur(6px) saturate(120%)}
.poemLine{font-size:clamp(16px,2.6vw,20px);line-height:1.45;color:#efeef8;min-height:2.2em;margin:6px 0;white-space:pre-wrap;overflow:hidden}

/* breathing light (subtle) */
.breath{position:absolute;inset:0;z-index:5;pointer-events:none;mix-blend-mode:screen;opacity:0.28;background:radial-gradient(circle at 50% 40%, rgba(200,120,255,0.06), transparent 12%), radial-gradient(circle at 20% 70%, rgba(255,160,180,0.03), transparent 10%);filter:blur(36px);animation:breathe 6s ease-in-out infinite}
@keyframes breathe{0%{transform:scale(1);opacity:0.28}50%{transform:scale(1.04);opacity:0.42}100%{transform:scale(1);opacity:0.28}}

/* proposal overlay */
.proposalOverlay{position:absolute;inset:0;z-index:22;display:flex;align-items:center;justify-content:center;pointer-events:none;opacity:0;transition:opacity .8s ease}
.proposalCard{pointer-events:auto;background: linear-gradient(180deg, rgba(8,6,18,0.75), rgba(8,6,18,0.6));border-radius:18px;padding:26px;text-align:center;border:1px solid rgba(255,255,255,0.05);box-shadow:0 30px 80px rgba(20,8,40,0.6);width:min(720px,92%)}
.proposalText{font-size:clamp(18px,3.8vw,28px);margin-bottom:18px}
.yesNoRow{display:flex;gap:14px;justify-content:center}

/* petal canvas sits above bouquet canvas */
#bouquetCanvas{position:absolute;inset:0;z-index:12;pointer-events:none}
#petalCanvas{position:absolute;inset:0;z-index:24;pointer-events:none}

/* small helpers */
.fallback{margin-top:16px;pointer-events:auto;display:inline-block}
.dodged{transform:translateX(24px) translateY(-8px) scale(1.02);transition:transform .18s cubic-bezier(.2,.9,.3,1)}
.tip{margin-top:10px;font-size:13px;color:rgba(255,255,255,0.65)}

@media (max-width:520px){
.mysteryButton{padding:14px 20px;border-radius:20px;font-size:18px}
.poemLine{font-size:15px}
.proposalCard{padding:18px}
} </style>

</head>
<body>
<div id="app" aria-live="polite">
  <!-- Canvases -->
  <canvas id="mainCanvas" aria-hidden="true"></canvas>      <!-- starfield + tulips -->
  <canvas id="bouquetCanvas" aria-hidden="true"></canvas>   <!-- bouquet flight + ribbon -->
  <canvas id="petalCanvas" aria-hidden="true"></canvas>     <!-- petal rain -->

  <div class="fog" aria-hidden="true"></div>

  <!-- UI -->

  <div class="ui" id="ui">
    <div class="introText" id="introText">This isnâ€™t a normal websiteâ€¦</div>

```
<div id="introControls" style="margin-top:16px;">
  <button id="tapBtn" class="mysteryButton pulse" aria-label="Tap me to continue">Tap Me</button>
  <div class="fallback" id="fallbackContinue" style="display:none;">
    <button id="fallbackBtn" class="btn">Continue</button>
  </div>
</div>

<!-- Tulip controls -->
<div id="tulipControls" style="display:none;margin-top:8px;">
  <div class="controlRow">
    <button id="continuePoem" class="btn bigAction">Continue</button>
  </div>
</div>

<!-- Poem -->
<div id="poemScene" style="display:none;margin-top:8px;position:relative;">
  <div class="breath" aria-hidden="true"></div>
  <div class="poemBox" id="poemBox" aria-live="polite">
    <div id="poemLine1" class="poemLine"></div>
    <div id="poemLine2" class="poemLine"></div>
  </div>
  <div class="controlRow" style="margin-top:12px;">
    <button id="nextPoemBtn" class="btn bigAction">Next</button>
  </div>
</div>

<!-- Build up -->
<div id="buildControls" style="display:none;margin-top:12px;">
  <div class="controlRow">
    <button id="oneLast" class="btn bigAction">One Last Thingâ€¦</button>
  </div>
</div>

<!-- Proposal -->
<div class="proposalOverlay" id="proposalOverlay" role="dialog" aria-modal="true" style="display:flex;">
  <div class="proposalCard" id="proposalCard" style="display:none;">
    <div class="proposalText" id="proposalText">Will you be my universe? ðŸ’«</div>
    <div class="yesNoRow">
      <button id="yesBtn" class="btn bigAction" style="background:linear-gradient(180deg,#ffecf8,#ffdff2); color:#3b0b2e;">YES</button>
      <button id="noBtn" class="btn bigAction" style="background:linear-gradient(180deg,#1a1a1a,#0e0c12); color:#fff;">NO</button>
    </div>
    <div class="tip">(Tip: be sincere)</div>
  </div>
</div>
```

  </div>
</div>

<script>
/*
  Final Single-file Romantic Proposal (index.html)
  - Entirely offline: HTML + CSS + Vanilla JS
  - Scenes: Intro (starfield) -> Tulip Garden -> Poem -> Build-up -> Bouquet -> Proposal
  - WebAudio synthetic: ambient wind, heartbeat, whoosh, chime
  - Touch-friendly, safe auto-advance, fallbacks, try/catch guards
*/

(function(){
  'use strict';

  /* ---------- App state encapsulation ---------- */
  const App = {
    scene: 'intro', // intro, tulips, poem, build, bouquet, proposal
    width: 0, height: 0,
    dpr: Math.min(window.devicePixelRatio || 1, 2),
    raf: null,
    audioCtx: null,
    audioNodes: {},
    lastInteraction: Date.now(),
    poemLines: [],
    poemIndex: 0
  };

  /* ---------- DOM elements ---------- */
  const el = {
    app: document.getElementById('app'),
    mainCanvas: document.getElementById('mainCanvas'),
    bouquetCanvas: document.getElementById('bouquetCanvas'),
    petalCanvas: document.getElementById('petalCanvas'),
    introText: document.getElementById('introText'),
    tapBtn: document.getElementById('tapBtn'),
    fallbackContinue: document.getElementById('fallbackContinue'),
    fallbackBtn: document.getElementById('fallbackBtn'),
    tulipControls: document.getElementById('tulipControls'),
    continuePoem: document.getElementById('continuePoem'),
    poemScene: document.getElementById('poemScene'),
    poemLine1: document.getElementById('poemLine1'),
    poemLine2: document.getElementById('poemLine2'),
    nextPoemBtn: document.getElementById('nextPoemBtn'),
    buildControls: document.getElementById('buildControls'),
    oneLast: document.getElementById('oneLast'),
    proposalOverlay: document.getElementById('proposalOverlay'),
    proposalCard: document.getElementById('proposalCard'),
    yesBtn: document.getElementById('yesBtn'),
    noBtn: document.getElementById('noBtn'),
    poemBox: document.getElementById('poemBox')
  };

  /* ---------- Canvas setup ---------- */
  const mainCtx = el.mainCanvas.getContext('2d', { alpha:true, willReadFrequently:false });
  const bouquetCtx = el.bouquetCanvas.getContext('2d', { alpha:true });
  const petalCtx = el.petalCanvas.getContext('2d', { alpha:true });

  function resizeCanvas(){
    try{
      App.width = Math.max(document.documentElement.clientWidth || 300, 300);
      App.height = Math.max(document.documentElement.clientHeight || 300, 300);
      const ratio = App.dpr;
      [el.mainCanvas, el.bouquetCanvas, el.petalCanvas].forEach(c=>{
        c.width = Math.floor(App.width * ratio);
        c.height = Math.floor(App.height * ratio);
        c.style.width = App.width + 'px';
        c.style.height = App.height + 'px';
        const ctx = c.getContext('2d');
        ctx.setTransform(ratio,0,0,ratio,0,0);
      });
    }catch(e){
      console.warn('resizeCanvas failed', e);
    }
  }
  window.addEventListener('resize', resizeCanvas, { passive:true });
  resizeCanvas();

  /* ---------- Audio: init and nodes ---------- */
  function initAudio(){
    try{
      if(App.audioCtx) return;
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      App.audioCtx = new AudioCtx();

      const master = App.audioCtx.createGain();
      master.gain.value = 0.85;
      master.connect(App.audioCtx.destination);
      App.audioNodes.master = master;

      setupAmbientWind();
      setupHeartbeat();
    }catch(e){
      console.warn('Audio init error', e);
    }
  }

  // Ambient wind (looping filtered noise)
  function setupAmbientWind(){
    try{
      const ctx = App.audioCtx;
      const len = ctx.sampleRate * 2.2;
      const buffer = ctx.createBuffer(1, len, ctx.sampleRate);
      const data = buffer.getChannelData(0);
      for(let i=0;i<len;i++){
        const white = (Math.random()*2 - 1);
        data[i] = (white + (i?data[i-1]:0)*0.92) * 0.55;
      }
      const src = ctx.createBufferSource();
      src.buffer = buffer;
      src.loop = true;

      const biq = ctx.createBiquadFilter();
      biq.type = 'lowpass';
      biq.frequency.value = 1200;

      const gain = ctx.createGain();
      gain.gain.value = 0.12;

      src.connect(biq);
      biq.connect(gain);
      gain.connect(App.audioNodes.master);

      src.start();
      App.audioNodes.wind = { src, biq, gain };
    }catch(e){
      console.warn('setupAmbientWind error', e);
    }
  }

  // Heartbeat (slow bass pulse)
  function setupHeartbeat(){
    try{
      const ctx = App.audioCtx;
      const osc = ctx.createOscillator();
      osc.type = 'sine';
      osc.frequency.value = 34;

      const gain = ctx.createGain();
      gain.gain.value = 0.0;

      osc.connect(gain);
      gain.connect(App.audioNodes.master);
      osc.start();

      App.audioNodes.heartbeat = { osc, gain };

      function pulse(){
        const now = ctx.currentTime;
        gain.gain.cancelScheduledValues(now);
        gain.gain.setValueAtTime(0.02, now);
        gain.gain.exponentialRampToValueAtTime(0.8, now + 0.18);
        gain.gain.exponentialRampToValueAtTime(0.02, now + 0.9);
      }
      App.audioNodes.heartbeat.timer = setInterval(pulse, 900);
      pulse();
    }catch(e){
      console.warn('setupHeartbeat error', e);
    }
  }

  function playWhoosh(){
    try{
      if(!App.audioCtx) return;
      const ctx = App.audioCtx;
      const dur = 0.36;
      const bufferSize = ctx.sampleRate * dur;
      const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
      const data = buffer.getChannelData(0);
      for(let i=0;i<bufferSize;i++){
        data[i] = (Math.random()*2-1) * Math.exp(-i/(bufferSize*0.9));
      }
      const src = ctx.createBufferSource();
      src.buffer = buffer;
      const f = ctx.createBiquadFilter(); f.type = 'lowpass'; f.frequency.value = 4000;
      const g = ctx.createGain(); g.gain.value = 0.9;
      src.connect(f); f.connect(g); g.connect(App.audioNodes.master);
      src.start();
      f.frequency.setValueAtTime(4000, ctx.currentTime);
      f.frequency.exponentialRampToValueAtTime(700, ctx.currentTime + dur);
    }catch(e){
      console.warn('playWhoosh error', e);
    }
  }

  function playChime(){
    try{
      if(!App.audioCtx) return;
      const ctx = App.audioCtx;
      const t = ctx.currentTime;
      const base = 440;
      const freqs = [base, base*1.5, base*2.02, base*2.99];
      freqs.forEach((f,i)=>{
        const osc = ctx.createOscillator();
        osc.type = 'sine';
        osc.frequency.value = f * (1 + (Math.random()-0.5)*0.01);
        const g = ctx.createGain();
        g.gain.value = 0;
        const filter = ctx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.value = 7200 - i*700;
        osc.connect(filter); filter.connect(g); g.connect(App.audioNodes.master);
        g.gain.setValueAtTime(0, t);
        g.gain.linearRampToValueAtTime(0.18/(i+1), t+0.02 + i*0.03);
        g.gain.exponentialRampToValueAtTime(0.0001, t + 3 + i*0.4);
        osc.start(t + i*0.02); osc.stop(t + 4 + i*0.5);
      });
      // soft overtone
      const gl = ctx.createOscillator(); gl.type = 'triangle'; gl.frequency.value = base*0.5;
      const gg = ctx.createGain(); gg.gain.value = 0;
      gl.connect(gg); gg.connect(App.audioNodes.master);
      gg.gain.setValueAtTime(0, t);
      gg.gain.linearRampToValueAtTime(0.06, t+0.05);
      gg.gain.exponentialRampToValueAtTime(0.0001, t+3.2);
      gl.start(t); gl.stop(t+3.6);
    }catch(e){
      console.warn('playChime error', e);
    }
  }

  /* ---------- Utility ---------- */
  function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
  function safe(fn){ try{ fn(); }catch(e){ console.warn('safe', e); } }

  /* ---------- Starfield (intro) ---------- */
  const Starfield = (function(){
    let stars = [];
    let t = 0;
    function init(){
      stars = [];
      const count = Math.round(App.width * App.height / 11000); // scale with screen
      for(let i=0;i<count;i++){
        stars.push({
          x: Math.random() * App.width,
          y: Math.random() * App.height,
          r: Math.random() * 1.6 + 0.3,
          hue: 250 + Math.random()*80,
          phase: Math.random() * Math.PI * 2,
          speed: 0.2 + Math.random() * 0.7
        });
      }
    }
    function draw(now, dt){
      try{
        t += dt;
        const ctx = mainCtx;
        // background base
        const g = ctx.createLinearGradient(0,0,0,App.height);
        g.addColorStop(0,'#030007');
        g.addColorStop(1,'#050012');
        ctx.fillStyle = g;
        ctx.fillRect(0,0,App.width,App.height);

        // nebula glow
        const ng = ctx.createRadialGradient(App.width*0.2, App.height*0.15, 0, App.width*0.2, App.height*0.15, Math.max(App.width,App.height)*0.8);
        ng.addColorStop(0,'rgba(120,60,200,0.09)');
        ng.addColorStop(0.65,'rgba(60,20,80,0.02)');
        ng.addColorStop(1,'rgba(0,0,0,0)');
        ctx.fillStyle = ng;
        ctx.fillRect(0,0,App.width,App.height);

        // stars
        for(const s of stars){
          const tw = (Math.sin(t * 0.9 + s.phase) + 1) * 0.5;
          const size = s.r * (0.85 + tw*0.7);
          const hue = s.hue + Math.sin(t*0.22 + s.phase)*6;
          ctx.beginPath();
          ctx.globalAlpha = 0.5 + tw*0.5;
          ctx.fillStyle = `hsl(${hue} 100% ${clamp(60+tw*30,50,92)}%)`;
          ctx.arc(s.x + Math.sin(t * s.speed*0.011 + s.phase)*6, s.y + Math.cos(t * s.speed*0.012 + s.phase)*3, size, 0, Math.PI*2);
          ctx.fill();
        }
        ctx.globalAlpha = 1;
      }catch(e){
        console.warn('Starfield draw error', e);
      }
    }
    return { init, draw };
  })();

  /* ---------- Tulip Garden ---------- */
  const TulipGarden = (function(){
    let tulips = [];
    function makePetalLayers(hue, size){
      return [
        { r: size*0.7, layer:-1, stops:[{p:0,c:'rgba(8,6,16,0.0)'},{p:1,c:'rgba(8,4,20,0.36)'}] },
        { r: size*0.62, layer:0, stops:[{p:0,c:'rgba(255,245,248,0.98)'},{p:1,c:`hsl(${hue},86%,46%)`} ]},
        { r: size*0.42, layer:1, stops:[{p:0,c:'rgba(255,255,255,0.96)'},{p:1,c:`hsl(${hue},86%,62%)`}]}
      ];
    }

    function generate(count){
      tulips = [];
      for(let i=0;i<count;i++){
        const depth = Math.random(); // 0 far, 1 near
        const x = Math.random() * App.width;
        const y = App.height * (0.45 + depth*0.5 + Math.random()*0.05);
        const size = 18 + depth*46 + Math.random()*22;
        const hue = 320 + Math.random()*60;
        tulips.push({
          x,y,depth,size,hue,swayPhase:Math.random()*Math.PI*2,swaySpeed:0.0008 + Math.random()*0.0014,
          stemCurviness: 0.06 + Math.random()*0.22,
          petals: makePetalLayers(hue, size),
          seed: Math.random()
        });
      }
      // painter's algorithm: farthest first
      tulips.sort((a,b)=>a.depth - b.depth);
    }

    function draw(now){
      try{
        const ctx = mainCtx;
        // soft ground gradient
        const g = ctx.createLinearGradient(0, App.height*0.45, 0, App.height);
        g.addColorStop(0,'rgba(10,6,12,0.0)');
        g.addColorStop(1,'rgba(5,3,6,0.62)');
        ctx.fillStyle = g;
        ctx.fillRect(0, App.height*0.45, App.width, App.height*0.55);

        const t = now;
        for(const tulp of tulips){
          // sway
          const sway = Math.sin(t * tulp.swaySpeed + tulp.swayPhase) * (8 + (1 - tulp.depth) * 8);
          const stemTopX = tulp.x + sway;
          const stemTopY = tulp.y;

          // stem - bezier curve
          const baseX = tulp.x + (tulp.seed - 0.5) * 16;
          const baseY = App.height + 40;
          const cp1x = baseX + (stemTopX - baseX) * (tulp.stemCurviness + 0.1) + (Math.sin(tulp.seed*10 + t)*4);
          const cp1y = baseY - (App.height - stemTopY)*0.45;
          const cp2x = baseX + (stemTopX - baseX) * (0.6 + tulp.stemCurviness) + (Math.cos(tulp.seed*9 + t)*6);
          const cp2y = baseY - (App.height - stemTopY)*0.78;

          ctx.lineWidth = clamp(1.3 * (1 + tulp.size*0.02), 0.5, 6.0);
          ctx.strokeStyle = `rgba(34,86,38,${0.78 - tulp.depth*0.52})`;
          ctx.beginPath();
          ctx.moveTo(baseX, baseY);
          ctx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, stemTopX, stemTopY);
          ctx.stroke();

          // soft shadow under flower (depth)
          const shadowRad = 8 + (1 - tulp.depth)*18;
          const sx = stemTopX + 6;
          const sy = stemTopY + 8 + (1 - tulp.depth) * 10;
          const shgr = ctx.createRadialGradient(sx, sy, 1, sx, sy, shadowRad*1.6);
          shgr.addColorStop(0,'rgba(0,0,0,0.28)');
          shgr.addColorStop(1,'rgba(0,0,0,0)');
          ctx.fillStyle = shgr;
          ctx.beginPath();
          ctx.ellipse(sx, sy, shadowRad, shadowRad*0.46, 0, 0, Math.PI*2);
          ctx.fill();

          // petals: layered radial gradients + subtle rotation
          const cx = stemTopX, cy = stemTopY;
          for(const p of tulp.petals){
            const grad = ctx.createRadialGradient(cx, cy - p.r*0.18, p.r*0.04, cx, cy, p.r*1.2);
            for(const s of p.stops) grad.addColorStop(s.p, s.c);
            ctx.fillStyle = grad;

            ctx.save();
            const rot = Math.sin(t * 0.0009 + tulp.swayPhase + p.layer) * 0.45;
            ctx.translate(cx, cy - p.layer*1.6);
            ctx.rotate(rot);
            ctx.beginPath();
            ctx.ellipse(0, 0, p.r * (1.14 - tulp.depth*0.36), p.r * (0.9 - tulp.depth*0.18), 0, 0, Math.PI*2);
            ctx.fill();
            ctx.restore();
          }

          // small center glow to add realism
          const glow = ctx.createRadialGradient(cx, cy, 0, cx, cy, 26);
          glow.addColorStop(0,'rgba(255,255,255,0.14)');
          glow.addColorStop(1,'rgba(255,255,255,0)');
          ctx.fillStyle = glow;
          ctx.beginPath();
          ctx.arc(cx, cy, 16 * (1 - tulp.depth*0.3), 0, Math.PI*2);
          ctx.fill();
        }

      }catch(e){
        console.warn('Tulip draw error', e);
      }
    }

    // detach a handful into bouquet flight
    function detachIntoBouquet(targetX, targetY){
      // choose several front tulips (largest depths)
      const fronts = tulips.slice().filter(t=>t.depth > 0.55);
      // sort by depth descending (closest first)
      fronts.sort((a,b)=>b.depth-a.depth);
      const chosen = fronts.slice(0, Math.min(10, fronts.length));
      return chosen.map((t,i)=>({
        x: t.x, y: t.y, hue: t.hue, r: t.size,
        vx: (targetX - t.x) / (480 + Math.random()*120) + (Math.random()-0.5)*0.6,
        vy: (targetY - t.y) / (720 + Math.random()*160) + (Math.random()*-0.3),
        wobble: Math.random()*0.6 - 0.3,
        offset: i
      }));
    }

    return { generate, draw, detachIntoBouquet };
  })();

  /* ---------- Particles (button disintegration) ---------- */
  const Particles = (function(){
    let parts = [];
    function spawn(x,y,color,count=60){
      for(let i=0;i<count;i++){
        parts.push({
          x,y,
          vx:(Math.random()-0.5)*6,
          vy:(Math.random()-0.9)*-6,
          rot:Math.random()*Math.PI*2,
          vr:(Math.random()-0.5)*0.18,
          life:0.8 + Math.random()*1.4,
          age:0,
          size: 2 + Math.random()*8,
          color: color || `hsl(${320 + Math.random()*60} 86% ${40+Math.random()*26}%)`
        });
      }
    }
    function updateAndDraw(ctx, dt){
      try{
        if(!parts.length) return;
        for(let i=parts.length-1;i>=0;i--){
          const p = parts[i];
          p.age += dt;
          if(p.age > p.life){ parts.splice(i,1); continue; }
          p.vy += 12.2 * dt;
          p.x += p.vx * (60*dt);
          p.y += p.vy * (60*dt);
          p.rot += p.vr;
          const alpha = Math.max(0,1 - p.age / p.life);
          ctx.save();
          ctx.globalAlpha = alpha;
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot);
          ctx.beginPath();
          ctx.fillStyle = p.color;
          ctx.ellipse(0,0, p.size*0.62, p.size*0.9, 0, 0, Math.PI*2);
          ctx.fill();
          ctx.restore();
        }
      }catch(e){
        console.warn('Particles update error', e);
      }
    }
    return { spawn, updateAndDraw };
  })();

  /* ---------- Bouquet flight + ribbon ---------- */
  const Bouquet = (function(){
    let flowers = [];
    let ribbon = null;
    let running = false;
    function start(defs, targetX, targetY){
      try{
        running = true;
        flowers = defs.map(d=>({
          x: d.x, y: d.y, vx: d.vx, vy: d.vy, r: d.r, hue: d.hue, wobble: d.wobble, life: 3.4 + Math.random()*1.0, age: 0
        }));
        ribbon = { x: targetX, y: targetY, t:0, settled:false };
      }catch(e){
        console.warn('Bouquet start error', e);
      }
    }
    function updateAndDraw(ctx, dt){
      try{
        if(!running) return;
        ctx.save();
        for(let i=flowers.length-1;i>=0;i--){
          const f = flowers[i];
          f.age += dt;
          if(f.age > f.life){ flowers.splice(i,1); continue; }
          f.vy += 5.4 * dt;
          f.x += f.vx * (60*dt);
          f.y += f.vy * (60*dt) + Math.sin(f.age*6 + f.wobble) * 0.6;
          // draw small flower head
          ctx.beginPath();
          ctx.fillStyle = `hsl(${f.hue} 82% 60%)`;
          ctx.arc(f.x, f.y, Math.max(4, f.r*0.16), 0, Math.PI*2);
          ctx.fill();
          // tiny petals
          ctx.save();
          ctx.translate(f.x,f.y);
          for(let p=0;p<5;p++){
            ctx.rotate(Math.PI*2/5);
            ctx.beginPath();
            ctx.ellipse(8,0, f.r*0.14, f.r*0.26, 0, 0, Math.PI*2);
            ctx.fillStyle = `rgba(255,245,248,${0.9 - p*0.12})`;
            ctx.fill();
          }
          ctx.restore();
        }
        // ribbon swirl
        if(ribbon){
          ribbon.t += dt * 1.7;
          const tx = ribbon.x, ty = ribbon.y;
          for(let i=0;i<4;i++){
            ctx.beginPath();
            const r = 18 + i*8 + Math.sin(ribbon.t*1.5 + i)*6;
            ctx.ellipse(tx, ty + 6, r, r*0.28, Math.sin(ribbon.t + i)*0.4, 0, Math.PI*2);
            ctx.strokeStyle = `rgba(255,220,240,${0.14 - i*0.02})`;
            ctx.lineWidth = 2.2;
            ctx.stroke();
          }
          // bow knot
          ctx.beginPath();
          ctx.fillStyle = 'rgba(255,200,230,0.98)';
          ctx.ellipse(tx-6, ty-2, 10,6, -0.6, 0, Math.PI*2);
          ctx.ellipse(tx+6, ty-2, 10,6, 0.6, 0, Math.PI*2);
          ctx.fill();
          ctx.beginPath();
          ctx.fillStyle = 'rgba(220,90,140,1)';
          ctx.arc(tx, ty+6, 4, 0, Math.PI*2);
          ctx.fill();
        }
        ctx.restore();
      }catch(e){
        console.warn('Bouquet draw error', e);
      }
    }
    function isDone(){ return flowers.length === 0; }
    function stop(){ running = false; flowers = []; ribbon = null; }
    return { start, updateAndDraw, isDone, stop };
  })();

  /* ---------- Petal rain ---------- */
  const PetalRain = (function(){
    let petals = [];
    function start(count=70){
      petals = [];
      for(let i=0;i<count;i++){
        petals.push({
          x: Math.random()*App.width,
          y: -Math.random()*App.height,
          vx: (Math.random()-0.5)*0.6,
          vy: 0.6 + Math.random()*1.6,
          rot: Math.random()*Math.PI*2,
          vr: (Math.random()-0.5)*0.06,
          size: 8 + Math.random()*18,
          hue: 320 + Math.random()*60
        });
      }
    }
    function updateAndDraw(ctx, dt){
      try{
        ctx.save();
        for(let i=petals.length-1;i>=0;i--){
          const p = petals[i];
          p.x += p.vx * (80*dt);
          p.y += p.vy * (80*dt);
          p.rot += p.vr;
          if(p.y > App.height + 40){ petals.splice(i,1); continue; }
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot);
          ctx.beginPath();
          ctx.ellipse(0,0, p.size*0.6, p.size, 0, 0, Math.PI*2);
          const g = ctx.createLinearGradient(-p.size, -p.size, p.size, p.size);
          g.addColorStop(0, 'rgba(255,255,255,0.96)');
          g.addColorStop(1, `hsl(${p.hue} 86% 60%)`);
          ctx.fillStyle = g;
          ctx.globalAlpha = 0.95;
          ctx.fill();
          ctx.restore();
        }
        ctx.restore();
      }catch(e){
        console.warn('Petal draw error', e);
      }
    }
    return { start, updateAndDraw };
  })();

  /* ---------- Poem ---------- */
  const Poem = (function(){
    function init(){
      const poemText = `Sometimes I think I fell for you
before I even learned how falling works.
My words trip over themselves..
And as I said earlier.. you're like a Luminous Singularity
which's parallel yet coincidently intersecting...
Like constellations shuffled in a hurry...
Orion losing its belt..
Cassiopeia sitting upside down..
and whole sky is asking "Why is she the only one shining this bright?"
And I swear ... 
every time i try to explain what you mean to me.. I fumble..I'm scared...
and my heart chooses Your tulips instead of sentences 
petals arranged in a wrong order.. yet beautiful..
Colors mixing where they shouldn't yet somehow looking eternal..
and it's strange how You make the universe feel like a misprinted bouquet..
Galaxies scribbled over with your name..
planets orbiting a little too close..
a pull like the Black hole..
Like they too forgot their distance.
And me? I'm jst a boy holding a bouquet thinking maybe if I say it wrong enough times
you Might hear the truth hidden between the mistakes
That in every star's cold shimmer and every tulip's quite softness
i keep finding you 
not perfectly..
not clearly 
but completely...`;
      App.poemLines = poemText.split('\n');
      App.poemIndex = 0;
    }
    let typing = false;
    function showNextPair(){
      if(typing) return;
      typing = true;
      const i = App.poemIndex;
      const l1 = App.poemLines[i] || '';
      const l2 = App.poemLines[i+1] || '';
      App.poemIndex += 2;
      el.poemLine1.textContent = '';
      el.poemLine2.textContent = '';
      el.poemScene.style.display = 'block';
      el.poemBox.scrollIntoView({behavior:'smooth', block:'center'});

      function typeText(target, text, speed){
        return new Promise(resolve=>{
          let idx = 0;
          const t = setInterval(()=>{
            try{
              idx++;
              target.textContent = text.slice(0, idx);
              if(idx >= text.length){
                clearInterval(t);
                resolve();
              }
            }catch(e){ clearInterval(t); resolve(); }
          }, speed);
        });
      }

      (async ()=>{
        try{
          await typeText(el.poemLine1, l1, clamp(12 + l1.length/8, 6, 28));
          await new Promise(r=>setTimeout(r, 260));
          await typeText(el.poemLine2, l2, clamp(10 + l2.length/9, 6, 26));
          typing = false;
          if(App.poemIndex >= App.poemLines.length){
            setTimeout(()=>transitionToBuildUp(), 1200);
          }
        }catch(e){ typing=false; }
      })();
    }
    return { init, showNextPair };
  })();

  /* ---------- Scene transitions ---------- */
  function goToTulips(){
    try{
      App.scene = 'tulips';
      TulipGarden.generate(Math.floor(App.width/26) + 14);
      el.introText.style.opacity = 0;
      el.tapBtn.style.display = 'none';
      el.fallbackContinue.style.display = 'none';
      el.tulipControls.style.display = 'block';
      safe(()=>{ initAudio(); playWhoosh(); });
    }catch(e){
      console.warn('goToTulips', e);
    }
  }

  function transitionToPoem(){
    App.scene = 'poem';
    el.tulipControls.style.display = 'none';
    el.poemScene.style.display = 'block';
    Poem.init();
    Poem.showNextPair();
    safe(()=>playWhoosh());
  }

  function transitionToBuildUp(){
    App.scene = 'build';
    el.poemScene.style.display = 'none';
    el.buildControls.style.display = 'block';
    safe(()=>playWhoosh());
  }

  function startBouquetSequence(){
    try{
      App.scene = 'bouquet';
      el.buildControls.style.display = 'none';
      const tx = App.width / 2;
      const ty = App.height * 0.38;
      const defs = TulipGarden.detachIntoBouquet(tx, ty);
      Bouquet.start(defs, tx, ty);
      safe(()=>playWhoosh());
      // check bouquet completion and then show proposal
      (function check(){
        if(Bouquet.isDone()){
          setTimeout(()=>showProposal(), 650);
        } else {
          setTimeout(check, 360);
        }
      })();
    }catch(e){
      console.warn('startBouquetSequence', e);
    }
  }

  function showProposal(){
    App.scene = 'proposal';
    el.proposalOverlay.style.pointerEvents = 'auto';
    el.proposalOverlay.style.display = 'flex';
    setTimeout(()=>{ el.proposalOverlay.style.opacity = 1; el.proposalCard.style.display = 'block'; }, 60);
    // small heartbeat bump
    safe(()=>{
      if(App.audioNodes && App.audioNodes.heartbeat && App.audioCtx){
        const g = App.audioNodes.heartbeat.gain;
        const ctx = App.audioCtx;
        const now = ctx.currentTime;
        g.gain.cancelScheduledValues(now);
        g.gain.setValueAtTime(0.02, now);
        g.gain.linearRampToValueAtTime(0.95, now+0.6);
        g.gain.exponentialRampToValueAtTime(0.02, now+3.2);
      }
    });
  }

  /* ---------- Render loop ---------- */
  let last = performance.now();
  function render(now){
    try{
      const dt = Math.min(0.06, (now - last) / 1000);
      last = now;

      // draw background/starfield
      if(App.scene === 'intro'){
        Starfield.draw(now, dt);
      } else {
        Starfield.draw(now, dt);
        if(['tulips','poem','build','bouquet','proposal'].includes(App.scene)){
          TulipGarden.draw(now);
        }
      }

      // particles
      Particles.updateAndDraw(mainCtx, dt);

      // bouquet canvas (cleared each frame)
      bouquetCtx.clearRect(0,0,App.width,App.height);
      Bouquet.updateAndDraw(bouquetCtx, dt);

      // petal canvas
      petalCtx.clearRect(0,0,App.width,App.height);
      PetalRain.updateAndDraw(petalCtx, dt);

    }catch(e){
      console.warn('render error', e);
    } finally {
      App.raf = requestAnimationFrame(render);
    }
  }

  /* ---------- Event binding & flow ---------- */
  function bindUI(){
    function userTouch(){
      App.lastInteraction = Date.now();
      try{ initAudio(); }catch(e){}
    }

    el.tapBtn.addEventListener('click', (ev)=>{
      userTouch();
      const rect = el.tapBtn.getBoundingClientRect();
      const x = rect.left + rect.width/2;
      const y = rect.top + rect.height/2;
      Particles.spawn(x, y, null, 84);
      el.app.animate([{ transform:'scale(1)' }, { transform:'scale(1.03)' }], { duration:420, direction:'alternate', iterations:2, easing:'ease-out' });
      setTimeout(goToTulips, 520);
      safe(()=>playWhoosh());
    }, { passive:true });

    el.fallbackBtn.addEventListener('click', ()=>{ userTouch(); goToTulips(); }, { passive:true });

    el.continuePoem.addEventListener('click', ()=>{ userTouch(); transitionToPoem(); }, { passive:true });

    el.nextPoemBtn.addEventListener('click', ()=>{ userTouch(); Poem.showNextPair(); }, { passive:true });

    el.oneLast.addEventListener('click', ()=>{ userTouch(); startBouquetSequence(); }, { passive:true });

    el.yesBtn.addEventListener('click', ()=>{
      try{
        initAudio();
        playChime();
        PetalRain.start(160);
        showFinalText("You were always my favorite galaxy ðŸŒ™ðŸŒ·");
        playWhoosh();
      }catch(e){ console.warn('yes click', e); }
    }, { passive:true });

    // NO button playful dodge
    let dodgeCount = 0;
    el.noBtn.addEventListener('mouseenter', ()=>{
      try{
        if(dodgeCount < 2){
          dodgeCount++;
          el.noBtn.classList.add('dodged');
          setTimeout(()=>el.noBtn.classList.remove('dodged'), 420);
        }
      }catch(e){ console.warn('no mouseenter', e); }
    });
    el.noBtn.addEventListener('touchstart', (ev)=>{
      try{
        ev.preventDefault();
        if(dodgeCount < 2){
          dodgeCount++;
          el.noBtn.classList.add('dodged');
          setTimeout(()=>el.noBtn.classList.remove('dodged'), 420);
        } else {
          el.yesBtn.click();
        }
      }catch(e){ console.warn('no touch', e); }
    }, { passive:false });

    // global user activity refresh
    ['click','touchstart','keydown','mousemove','scroll'].forEach(evt=>{
      window.addEventListener(evt, ()=>{ App.lastInteraction = Date.now(); }, { passive:true });
    });
  }

  function showFinalText(text){
    try{
      el.proposalText.textContent = text;
      el.yesBtn.disabled = true;
      el.noBtn.disabled = true;
      el.proposalCard.animate([{ transform:'translateY(0) scale(1)' }, { transform:'translateY(-8px) scale(1.02)' }], { duration:800, direction:'alternate', iterations:2 });
    }catch(e){ console.warn('showFinalText', e); }
  }

  /* ---------- Auto-advance for safety ---------- */
  function setupAutoAdvance(){
    function check(){
      try{
        const since = Date.now() - App.lastInteraction;
        if(since > 10000){
          if(App.scene === 'intro') el.tapBtn.click();
          else if(App.scene === 'tulips') el.continuePoem.click();
          else if(App.scene === 'poem') el.nextPoemBtn.click();
          else if(App.scene === 'build') el.oneLast.click();
        }
      }catch(e){ console.warn('autoAdvance', e); }
      setTimeout(check, 3500);
    }
    setTimeout(check, 3500);
  }

  /* ---------- Initial reveal ---------- */
  function introReveal(){
    try{
      el.introText.style.opacity = 1;
      el.introText.style.transform = 'translateY(0)';
      setTimeout(()=>{ el.fallbackContinue.style.display = 'block'; }, 6000);
    }catch(e){ console.warn('introReveal', e); }
  }

  /* ---------- Init everything ---------- */
  function init(){
    try{
      resizeCanvas();
      Starfield.init();
      bindUI();
      introReveal();
      App.raf = requestAnimationFrame(render);
      // fallback continue displayed if something weird happens
      setTimeout(()=>{ el.fallbackContinue.style.display = 'block'; }, 8000);
      setupAutoAdvance();
      // attempt resume audio on first gesture
      window.addEventListener('click', initAudio, { once:true });
      window.addEventListener('touchstart', initAudio, { once:true });
    }catch(e){
      console.error('init error', e);
    }
  }

  /* ---------- Start ---------- */
  init();

  /* ---------- Expose nothing global ---------- */
})();

</script>

</body>
</html>
