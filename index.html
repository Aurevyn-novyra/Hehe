<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Will You Be My Universe?</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #ff006e;
            --secondary: #8338ec;
            --accent: #ffbe0b;
            --dark-bg: #0f0e17;
            --light-text: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--dark-bg);
            color: var(--light-text);
            width: 100%;
            height: 100vh;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            touch-action: none;
        }

        /* SCENE CONTAINERS */
        .scene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            opacity: 0;
            transition: opacity 0.8s ease;
            z-index: 100;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: var(--dark-bg);
        }

        .scene.active {
            display: flex;
            opacity: 1;
            z-index: 100;
        }

        .scene.hidden {
            display: none !important;
            opacity: 0 !important;
            z-index: -1 !important;
        }

        /* INTRO SCENE */
        #scene-intro {
            position: relative;
        }

        #intro-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .intro-content {
            position: relative;
            z-index: 10;
            text-align: center;
        }

        .intro-text {
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            font-weight: 300;
            letter-spacing: 2px;
            margin-bottom: 60px;
            opacity: 0;
            animation: fadeInText 2s ease 2s forwards;
            text-shadow: 0 0 20px rgba(255, 0, 110, 0.3);
        }

        @keyframes fadeInText {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse-button {
            padding: clamp(12px, 4vw, 18px) clamp(30px, 8vw, 50px);
            font-size: clamp(1.1rem, 4vw, 1.5rem);
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: 2px solid var(--primary);
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            opacity: 0;
            animation: pulseGlow 2s ease-in-out 4s infinite forwards;
            box-shadow: 0 0 30px rgba(255, 0, 110, 0.6);
            transition: all 0.3s ease;
            position: relative;
            min-width: 120px;
            touch-action: manipulation;
        }

        @keyframes pulseGlow {
            0%, 100% {
                opacity: 0.8;
                box-shadow: 0 0 20px rgba(255, 0, 110, 0.5),
                           0 0 40px rgba(131, 56, 236, 0.3);
                transform: scale(1);
            }
            50% {
                opacity: 1;
                box-shadow: 0 0 40px rgba(255, 0, 110, 0.8),
                           0 0 70px rgba(131, 56, 236, 0.6);
                transform: scale(1.08);
            }
        }

        .pulse-button:hover {
            transform: scale(1.12);
            box-shadow: 0 0 50px rgba(255, 0, 110, 1),
                       0 0 90px rgba(131, 56, 236, 0.9);
        }

        .pulse-button:active {
            transform: scale(0.95);
        }

        .pulse-button:focus {
            outline: 3px solid var(--accent);
            outline-offset: 2px;
        }

        /* GARDEN SCENE */
        #garden-canvas {
            width: 100%;
            height: 100%;
            display: block;
            position: absolute;
            top: 0;
            left: 0;
        }

        .garden-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-button {
            padding: 12px 24px;
            font-size: 1rem;
            background: rgba(131, 56, 236, 0.8);
            color: white;
            border: 2px solid var(--secondary);
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            touch-action: manipulation;
        }

        .control-button:hover {
            background: var(--secondary);
            transform: scale(1.08);
            box-shadow: 0 0 20px rgba(131, 56, 236, 0.8);
        }

        .control-button:focus {
            outline: 3px solid var(--accent);
            outline-offset: 2px;
        }

        /* POEM SCENE */
        #scene-poem {
            padding: 20px;
            overflow-y: auto;
            overflow-x: hidden;
            justify-content: flex-start;
            padding-top: 40px;
        }

        .poem-wrapper {
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
        }

        .poem-container {
            line-height: 2;
            font-size: clamp(0.95rem, 2.5vw, 1.2rem);
            text-align: center;
            position: relative;
            min-height: 60vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .poem-line {
            opacity: 0;
            animation: typewriterFade 0.6s ease-out forwards;
            min-height: 1.8em;
            display: block;
            margin: 0.3em 0;
            position: relative;
            text-shadow: 0 0 10px rgba(255, 0, 110, 0.2);
        }

        @keyframes typewriterFade {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .poem-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* BOUQUET SCENE */
        #bouquet-canvas {
            width: 100%;
            height: 100%;
            display: block;
            position: absolute;
            top: 0;
            left: 0;
        }

        .bouquet-prompt {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 40;
            font-size: clamp(1.1rem, 3vw, 1.4rem);
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 0 20px rgba(255, 0, 110, 0.5);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

        .bouquet-controls {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* PROPOSAL SCENE */
        .proposal-modal {
            background: rgba(15, 14, 23, 0.95);
            border: 2px solid var(--primary);
            border-radius: 20px;
            padding: 40px 20px;
            max-width: 90%;
            max-width: min(90%, 500px);
            text-align: center;
            box-shadow: 0 0 60px rgba(255, 0, 110, 0.5);
            z-index: 200;
            animation: modalSlideIn 0.6s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .proposal-text {
            font-size: clamp(1.8rem, 5vw, 2.8rem);
            font-weight: 700;
            margin-bottom: 40px;
            letter-spacing: 1px;
            text-shadow: 0 0 20px rgba(255, 0, 110, 0.4);
        }

        .button-group {
            display: flex;
            gap: clamp(10px, 4vw, 20px);
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 30px;
        }

        .yes-button, .no-button {
            padding: clamp(10px, 3vw, 16px) clamp(25px, 6vw, 50px);
            font-size: clamp(1rem, 3vw, 1.3rem);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s ease;
            touch-action: manipulation;
            min-width: 100px;
        }

        .yes-button {
            background: linear-gradient(135deg, #00ff88, #00ffcc);
            color: #000;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.6);
        }

        .yes-button:hover {
            box-shadow: 0 0 50px rgba(0, 255, 136, 1);
            transform: scale(1.12);
        }

        .yes-button:active {
            transform: scale(0.95);
        }

        .yes-button.shake {
            animation: shake 0.4s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0) scale(1.12); }
            25% { transform: translateX(-8px) scale(1.12); }
            75% { transform: translateX(8px) scale(1.12); }
        }

        .yes-button:focus {
            outline: 3px solid var(--accent);
            outline-offset: 2px;
        }

        .no-button {
            background: rgba(255, 255, 255, 0.08);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        }

        .no-button:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: scale(1.08);
        }

        .no-button:focus {
            outline: 3px solid var(--accent);
            outline-offset: 2px;
        }

        /* RESULT SCENE */
        #result-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .result-text {
            font-size: clamp(2rem, 6vw, 3.5rem);
            font-weight: 700;
            text-align: center;
            animation: resultFadeIn 1.5s ease;
            position: relative;
            z-index: 10;
            text-shadow: 0 0 30px rgba(255, 0, 110, 0.6);
            letter-spacing: 1px;
        }

        @keyframes resultFadeIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* AUDIO OVERLAY */
        .audio-overlay {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 300;
            background: rgba(131, 56, 236, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            cursor: pointer;
            border: 2px solid var(--secondary);
            transition: all 0.3s ease;
            display: none;
            touch-action: manipulation;
        }

        .audio-overlay.show {
            display: block;
            animation: slideInDown 0.5s ease;
        }

        @keyframes slideInDown {
            from {
                transform: translateY(-30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .audio-overlay:hover {
            background: var(--secondary);
            transform: scale(1.08);
            box-shadow: 0 0 20px rgba(131, 56, 236, 0.8);
        }

        .audio-overlay:focus {
            outline: 3px solid var(--accent);
            outline-offset: 2px;
        }

        /* MOBILE RESPONSIVE */
        @media (max-width: 768px) {
            .intro-text {
                font-size: 1.3rem;
                margin-bottom: 40px;
            }

            .poem-container {
                min-height: 50vh;
            }

            .proposal-modal {
                padding: 30px 15px;
            }

            .garden-controls,
            .poem-controls,
            .bouquet-controls {
                bottom: 15px;
                gap: 8px;
            }

            .control-button {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .intro-text {
                font-size: 1.1rem;
                margin-bottom: 30px;
            }

            .proposal-text {
                font-size: 1.5rem;
            }

            .result-text {
                font-size: 1.8rem;
                padding: 20px;
            }

            .button-group {
                gap: 8px;
                flex-direction: column;
            }

            .yes-button, .no-button {
                width: 100%;
            }

            .audio-overlay {
                top: 10px;
                right: 10px;
                padding: 10px 15px;
                font-size: 0.8rem;
            }
        }

        /* REDUCED MOTION */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        canvas {
            display: block;
        }

        .particle {
            position: fixed;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- INTRO SCENE -->
    <div id="scene-intro" class="scene active">
        <canvas id="intro-canvas"></canvas>
        <div class="intro-content">
            <div class="intro-text">This isn't a normal website...</div>
            <button id="intro-button" class="pulse-button" aria-label="Begin experience">tap me</button>
        </div>
    </div>

    <!-- GARDEN SCENE -->
    <div id="scene-garden" class="scene">
        <canvas id="garden-canvas"></canvas>
        <div class="garden-controls">
            <button id="garden-poem-button" class="control-button" aria-label="Go to poem">üìñ Poem</button>
            <button id="garden-reset-button" class="control-button" aria-label="Reset experience">‚Üª Reset</button>
        </div>
    </div>

    <!-- POEM SCENE -->
    <div id="scene-poem" class="scene">
        <div class="poem-wrapper">
            <div class="poem-container" id="poemContainer"></div>
        </div>
        <div class="poem-controls">
            <button id="poem-continue-button" class="control-button" aria-label="Continue to bouquet" style="margin-top: 20px;">‚Üí Continue</button>
            <button id="poem-back-button" class="control-button" aria-label="Back to garden">‚Üê Back</button>
        </div>
    </div>

    <!-- BOUQUET SCENE -->
    <div id="scene-bouquet" class="scene">
        <canvas id="bouquet-canvas"></canvas>
        <div class="bouquet-prompt">
            ‚ú® Touch the bouquet ‚ú®
        </div>
        <div class="bouquet-controls">
            <button id="bouquet-button" class="control-button" aria-label="Open proposal">Open Bouquet</button>
        </div>
    </div>

    <!-- PROPOSAL SCENE -->
    <div id="scene-proposal" class="scene">
        <div class="proposal-modal">
            <div class="proposal-text">Will you be my universe? üí´</div>
            <div class="button-group">
                <button id="yesButton" class="yes-button" aria-label="Accept proposal">YES</button>
                <button id="noButton" class="no-button" aria-label="Decline proposal">NO</button>
            </div>
        </div>
    </div>

    <!-- RESULT SCENE -->
    <div id="scene-result" class="scene">
        <canvas id="result-canvas"></canvas>
        <div class="result-text">You were always my favorite galaxy üåôüå∑</div>
    </div>

    <!-- AUDIO OVERLAY -->
    <div id="audioOverlay" class="audio-overlay" role="button" tabindex="0" aria-label="Enable sound">
        üîä Enable Sound
    </div>

    <script>
        // ======================================
        // CONFIG & CONSTANTS
        // ======================================
        const CONFIG = {
            AUTO_ADVANCE_DELAY: 8000,
            REDUCED_MOTION: window.matchMedia('(prefers-reduced-motion: reduce)').matches,
            PARTICLE_COUNT_FACTOR: window.devicePixelRatio > 1.5 ? 0.6 : 1,
        };

        // ======================================
        // AUDIO CONTEXT & SYNTHESIS
        // ======================================
        let audioContext = null;
        let audioStarted = false;
        const activeOscillators = [];

        function initAudio() {
            if (audioContext) return true;
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioStarted = true;
                document.getElementById('audioOverlay').classList.remove('show');
                return true;
            } catch (e) {
                console.warn('Audio context failed:', e);
                return false;
            }
        }

        function stopAllOscillators() {
            activeOscillators.forEach(osc => {
                try { osc.stop(); } catch (e) {}
            });
            activeOscillators.length = 0;
        }

        function playHeartbeat() {
            if (!audioContext) return;
            try {
                const now = audioContext.currentTime;
                for (let i = 0; i < 2; i++) {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.frequency.value = 60 + (i * 20);
                    osc.type = 'sine';
                    gain.gain.setValueAtTime(0.1, now + i * 0.08);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.08 + 0.1);
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    osc.start(now + i * 0.08);
                    osc.stop(now + i * 0.08 + 0.1);
                    activeOscillators.push(osc);
                }
            } catch (e) {
                console.warn('Heartbeat failed:', e);
            }
        }

        function playHeartbeatLoop() {
            if (!audioContext || !audioStarted) return;
            playHeartbeat();
            setTimeout(playHeartbeatLoop, 1500);
        }

        function playAmbientMusic() {
            if (!audioContext) return;
            try {
                const freqs = [110, 165, 220, 330];
                freqs.forEach(freq => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.frequency.value = freq;
                    osc.type = 'sine';
                    gain.gain.setValueAtTime(0.02, audioContext.currentTime);
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    osc.start();
                    activeOscillators.push(osc);
                });
            } catch (e) {
                console.warn('Ambient music failed:', e);
            }
        }

        function playWhoosh() {
            if (!audioContext) return;
            try {
                const now = audioContext.currentTime;
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.frequency.setValueAtTime(200, now);
                osc.frequency.exponentialRampToValueAtTime(50, now + 0.3);
                osc.type = 'sine';
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.start(now);
                osc.stop(now + 0.3);
                activeOscillators.push(osc);
            } catch (e) {
                console.warn('Whoosh failed:', e);
            }
        }

        function playBloom() {
            if (!audioContext) return;
            try {
                const now = audioContext.currentTime;
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.exponentialRampToValueAtTime(600, now + 0.2);
                osc.type = 'sine';
                gain.gain.setValueAtTime(0.08, now);
                gain.gain.exponentialRampToValueAtTime(0, now + 0.2);
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.start(now);
                osc.stop(now + 0.2);
                activeOscillators.push(osc);
            } catch (e) {
                console.warn('Bloom failed:', e);
            }
        }

        function playChime() {
            if (!audioContext) return;
            try {
                const now = audioContext.currentTime;
                const freqs = [523.25, 659.25, 783.99];
                freqs.forEach((freq, idx) => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.frequency.value = freq;
                    osc.type = 'sine';
                    gain.gain.setValueAtTime(0.1, now + idx * 0.05);
                    gain.gain.exponentialRampToValueAtTime(0, now + 0.5 + idx * 0.05);
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    osc.start(now + idx * 0.05);
                    osc.stop(now + 0.5 + idx * 0.05);
                    activeOscillators.push(osc);
                });
            } catch (e) {
                console.warn('Chime failed:', e);
            }
        }

        // ======================================
        // SCENE MANAGEMENT
        // ======================================
        function switchScene(fromId, toId) {
            const from = document.getElementById(fromId);
            const to = document.getElementById(toId);
            if (from) {
                from.classList.remove('active');
                from.classList.add('hidden');
            }
            if (to) {
                to.classList.remove('hidden');
                to.classList.add('active');
            }
        }

        // ======================================
        // INTRO SCENE
        // ======================================
        function initIntroScene() {
            const canvas = document.getElementById('intro-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const stars = Array.from({ length: 60 }, () => ({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                radius: Math.random() * 1.5,
                opacity: Math.random() * 0.5 + 0.3,
                twinkleSpeed: Math.random() * 0.05
            }));

            let frame = 0;
            function animate() {
                ctx.fillStyle = 'rgba(15, 14, 23, 0.3)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                stars.forEach(star => {
                    star.opacity += star.twinkleSpeed;
                    if (star.opacity > 1 || star.opacity < 0.2) star.twinkleSpeed *= -1;

                    ctx.fillStyle = `rgba(255, 255, 255, ${star.opacity})`;
                    ctx.beginPath();
                    ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.strokeStyle = `rgba(255, 255, 255, ${star.opacity * 0.3})`;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(star.x, star.y, star.radius + 3, 0, Math.PI * 2);
                    ctx.stroke();
                });

                frame++;
                requestAnimationFrame(animate);
            }
            animate();
        }

        // ======================================
        // GARDEN SCENE - HYPER-REALISTIC TULIPS
        // ======================================
        function initGardenScene() {
            const canvas = document.getElementById('garden-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const tulips = Array.from({ length: 100 }, () => ({
                x: Math.random() * canvas.width,
                y: canvas.height,
                height: Math.random() * 180 + 120,
                color: `hsl(${Math.random() * 60 + 330}, 95%, ${Math.random() * 35 + 45}%)`,
                lightColor: `hsl(${Math.random() * 60 + 330}, 100%, 70%)`,
                darkColor: `hsl(${Math.random() * 60 + 330}, 90%, 30%)`,
                petalCount: Math.floor(Math.random() * 3) + 5,
                swayAmount: Math.random() * 25,
                swaySpeed: Math.random() * 0.015 + 0.003,
                time: Math.random() * Math.PI * 2,
                bloomProgress: 0,
                bloomSpeed: Math.random() * 0.008 + 0.003,
                rotation: Math.random() * Math.PI * 0.3
            }));

            const stars = Array.from({ length: 120 }, () => ({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height * 0.6,
                size: Math.random() * 2.5,
                opacity: Math.random() * 0.8,
                twinkleSpeed: Math.random() * 0.03
            }));

            let frame = 0;

            function drawTulip(x, y, height, color, lightColor, darkColor, petals, sway, bloom, rotation) {
                ctx.save();
                ctx.translate(x + sway, y);
                ctx.rotate(rotation * 0.1);

                // Stem - gradient
                const stemGradient = ctx.createLinearGradient(0, 0, 10, -height);
                stemGradient.addColorStop(0, 'rgba(60, 140, 80, 0.8)');
                stemGradient.addColorStop(0.5, 'rgba(80, 160, 100, 0.7)');
                stemGradient.addColorStop(1, 'rgba(100, 180, 120, 0.6)');

                ctx.strokeStyle = stemGradient;
                ctx.lineWidth = 4;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.bezierCurveTo(6, -height * 0.3, -4, -height * 0.7, 0, -height);
                ctx.stroke();

                // Petals
                const petalHeight = height * (0.35 + bloom * 0.25);
                const petalWidth = 18 * (0.8 + bloom * 0.4);

                for (let i = 0; i < petals; i++) {
                    const angle = (Math.PI * 2 * i) / petals + (Math.PI / petals * 0.5);
                    ctx.save();
                    ctx.rotate(angle);

                    // Main petal
                    const petalGradient = ctx.createLinearGradient(0, -petalHeight * 0.8, 0, 0);
                    petalGradient.addColorStop(0, lightColor);
                    petalGradient.addColorStop(0.5, color);
                    petalGradient.addColorStop(1, darkColor);

                    ctx.fillStyle = petalGradient;
                    ctx.beginPath();
                    ctx.ellipse(0, -petalHeight * 0.5, petalWidth * bloom, petalHeight, 0.2, 0, Math.PI * 2);
                    ctx.fill();

                    // Petal shadow
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
                    ctx.beginPath();
                    ctx.ellipse(petalWidth * bloom * 0.2, -petalHeight * 0.4, petalWidth * bloom * 0.3, petalHeight * 0.4, 0.2, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.restore();
                }

                // Center stamen
                ctx.fillStyle = 'rgba(255, 200, 0, 0.8)';
                ctx.beginPath();
                ctx.arc(0, -height * 0.8, 4 + bloom * 2.5, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = 'rgba(200, 150, 0, 0.6)';
                ctx.beginPath();
                ctx.arc(1, -height * 0.79, 2, 0, Math.PI * 2);
                ctx.fill();

                ctx.restore();
            }

            function animate() {
                ctx.fillStyle = 'rgba(15, 14, 23, 0.95)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Draw stars with twinkle
                stars.forEach(star => {
                    star.opacity += star.twinkleSpeed;
                    if (star.opacity > 0.9 || star.opacity < 0.3) star.twinkleSpeed *= -1;

                    ctx.fillStyle = `rgba(255, 255, 255, ${star.opacity})`;
                    ctx.beginPath();
                    ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.strokeStyle = `rgba(255, 255, 255, ${star.opacity * 0.4})`;
                    ctx.lineWidth = 1.5;
                    ctx.beginPath();
                    ctx.arc(star.x, star.y, star.size + 2, 0, Math.PI * 2);
                    ctx.stroke();
                });

                // Draw and animate tulips
                tulips.forEach(tulip => {
                    tulip.time += tulip.swaySpeed;
                    tulip.bloomProgress = Math.min(tulip.bloomProgress + tulip.bloomSpeed, 1);
                    const sway = Math.sin(tulip.time) * tulip.swayAmount;

                    drawTulip(
                        tulip.x,
                        tulip.y - tulip.height,
                        tulip.height,
                        tulip.color,
                        tulip.lightColor,
                        tulip.darkColor,
                        tulip.petalCount,
                        sway,
                        tulip.bloomProgress,
                        tulip.rotation
                    );
                });

                frame++;
                requestAnimationFrame(animate);
            }
            animate();
        }

        // ======================================
        // POEM SCENE
        // ======================================
        const POEM_TEXT = `Sometimes I think I fell for you
before I even learned how falling works.
My words trip over themselves..
And as I said earlier.. you're like a Luminous Singularity
which's parallel yet coincidently intersecting...
Like constellations shuffled in a hurry...
Orion losing its belt..
Cassiopeia sitting upside down..
and whole sky is asking "Why is she the only one shining this bright?"
And I swear ... 
every time i try to explain what you mean to me.. I fumble..I'm scared...
and my heart chooses Your tulips instead of sentences 
petals arranged in a wrong order.. yet beautiful..
Colors mixing where they shouldn't yet somehow looking eternal..
and it's strange how You make the universe feel like a misprinted bouquet..
Galaxies scribbled over with your name..
planets orbiting a little too close..
a pull like the Black hole..
Like they too forgot their distance.
And me? I'm jst a boy holding a bouquet thinking maybe if I say it wrong enough times
you Might hear the truth hidden between the mistakes
That in every star's cold shimmer and every tulip's quite softness
i keep finding you 
not perfectly..
not clearly 
but completely...`;

        let poemDisplayTimeout;

        function displayPoem() {
            const container = document.getElementById('poemContainer');
            container.innerHTML = '';

            const lines = POEM_TEXT.split('\n');
            let lineIndex = 0;

            function displayNextLine() {
                if (lineIndex < lines.length) {
                    const line = lines[lineIndex];
                    const lineElement = document.createElement('div');
                    lineElement.className = 'poem-line';
                    lineElement.textContent = line || '\u00A0';
                    container.appendChild(lineElement);

                    if (lineIndex % 3 === 0 && audioStarted) playBloom();
                    if (lineIndex % 5 === 0 && audioStarted) playHeartbeat();

                    lineIndex++;
                    setTimeout(displayNextLine, 400);
                } else {
                    poemDisplayTimeout = setTimeout(() => {
                        if (document.getElementById('scene-poem').classList.contains('active')) {
                            goToBouquet();
                        }
                    }, CONFIG.AUTO_ADVANCE_DELAY);
                }
            }

            displayNextLine();
        }

        // ======================================
        // BOUQUET SCENE
        // ======================================
        function initBouquetScene() {
            const canvas = document.getElementById('bouquet-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const particles = [];
            let frame = 0;

            function createParticle(x, y, vx, vy, color, size) {
                particles.push({ x, y, vx, vy, color, size, life: 1, decay: Math.random() * 0.01 + 0.005 });
            }

            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;

            for (let i = 0; i < 60; i++) {
                const angle = (Math.PI * 2 * i) / 60;
                const distance = 100 + Math.random() * 60;
                const vx = Math.cos(angle) * distance * 0.015;
                const vy = Math.sin(angle) * distance * 0.015;
                const colors = ['#ff006e', '#8338ec', '#ffbe0b', '#fb5607', '#ff10f0'];
                const size = Math.random() * 8 + 5;
                createParticle(centerX, centerY, vx, vy, colors[Math.floor(Math.random() * colors.length)], size);
            }

            function animate() {
                ctx.fillStyle = 'rgba(15, 14, 23, 0.95)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Stem
                const stemGradient = ctx.createLinearGradient(centerX, canvas.height, centerX, centerY - 20);
                stemGradient.addColorStop(0, 'rgba(60, 140, 80, 0.8)');
                stemGradient.addColorStop(1, 'rgba(100, 180, 120, 0.6)');
                ctx.strokeStyle = stemGradient;
                ctx.lineWidth = 6;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(centerX, canvas.height);
                ctx.quadraticCurveTo(centerX + 10, centerY + 100, centerX, centerY - 20);
                ctx.stroke();

                // Ribbon wrap
                for (let i = 0; i < 3; i++) {
                    ctx.strokeStyle = `rgba(255, 0, 110, ${0.6 - i * 0.15})`;
                    ctx.lineWidth = 3 - i;
                    ctx.beginPath();
                    const startAngle = frame * 0.02 + (i * Math.PI / 3);
                    ctx.arc(centerX, centerY, 35 + i * 8, startAngle, startAngle + Math.PI * 1.5);
                    ctx.stroke();
                }

                // Update particles
                for (let i = particles.length - 1; i >= 0; i--) {
                    const p = particles[i];
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.15;
                    p.life -= p.decay;

                    if (p.life <= 0) {
                        particles.splice(i, 1);
                        continue;
                    }

                    ctx.fillStyle = p.color;
                    ctx.globalAlpha = p.life;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.globalAlpha = 1;
                }

                // Bouquet bloom
                const bloomSize = 45 + Math.sin(frame * 0.03) * 12;
                const bloomGradient = ctx.createRadialGradient(centerX, centerY, 10, centerX, centerY, bloomSize);
                bloomGradient.addColorStop(0, 'rgba(255, 150, 180, 0.9)');
                bloomGradient.addColorStop(0.7, 'rgba(255, 100, 150, 0.6)');
                bloomGradient.addColorStop(1, 'rgba(255, 0, 110, 0.2)');

                ctx.fillStyle = bloomGradient;
                ctx.beginPath();
                ctx.arc(centerX, centerY, bloomSize, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = 'rgba(255, 200, 100, 0.8)';
                ctx.beginPath();
                ctx.arc(centerX, centerY, bloomSize * 0.5, 0, Math.PI * 2);
                ctx.fill();

                frame++;
                requestAnimationFrame(animate);
            }
            animate();
        }

        // ======================================
        // RESULT SCENE
        // ======================================
        function initResultScene() {
            const canvas = document.getElementById('result-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const petals = [];
            let frame = 0;

            for (let i = 0; i < 50; i++) {
                petals.push({
                    x: Math.random() * canvas.width,
                    y: -20,
                    vx: (Math.random() - 0.5) * 2.5,
                    vy: Math.random() * 2.5 + 1,
                    rotation: Math.random() * Math.PI * 2,
                    rotationSpeed: (Math.random() - 0.5) * 0.15,
                    color: Math.random() > 0.5 ? '#ff006e' : '#ffbe0b',
                    size: Math.random() * 12 + 10
                });
            }

            function animate() {
                ctx.fillStyle = 'rgba(15, 14, 23, 0.2)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                petals.forEach(petal => {
                    petal.x += petal.vx;
                    petal.y += petal.vy;
                    petal.rotation += petal.rotationSpeed;

                    ctx.save();
                    ctx.translate(petal.x, petal.y);
                    ctx.rotate(petal.rotation);
                    ctx.fillStyle = petal.color;
                    ctx.beginPath();
                    ctx.ellipse(0, 0, petal.size, petal.size * 0.6, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                });

                const glowIntensity = 0.3 + Math.sin(frame * 0.02) * 0.4;
                const glowGradient = ctx.createRadialGradient(canvas.width / 2, canvas.height / 2, 50, canvas.width / 2, canvas.height / 2, 300);
                glowGradient.addColorStop(0, `rgba(255, 0, 110, ${glowIntensity * 0.5})`);
                glowGradient.addColorStop(1, 'rgba(255, 0, 110, 0)');

                ctx.fillStyle = glowGradient;
                ctx.beginPath();
                ctx.arc(canvas.width / 2, canvas.height / 2, 300, 0, Math.PI * 2);
                ctx.fill();

                frame++;
                if (frame < 300) requestAnimationFrame(animate);
            }
            animate();
        }

        // ======================================
        // BUTTON HANDLERS
        // ======================================

        document.getElementById('intro-button').addEventListener('click', () => {
            if (audioStarted) playWhoosh();
            initAudio();
            switchScene('scene-intro', 'scene-garden');
            setTimeout(initGardenScene, 100);
        });

        document.getElementById('intro-button').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                document.getElementById('intro-button').click();
            }
        });

        document.getElementById('garden-poem-button').addEventListener('click', () => {
            clearTimeout(poemDisplayTimeout);
            if (audioStarted) playWhoosh();
            switchScene('scene-garden', 'scene-poem');
            setTimeout(displayPoem, 100);
        });

        document.getElementById('garden-reset-button').addEventListener('click', () => {
            clearTimeout(poemDisplayTimeout);
            stopAllOscillators();
            location.reload();
        });

        document.getElementById('poem-continue-button').addEventListener('click', goToBouquet);
        document.getElementById('poem-back-button').addEventListener('click', () => {
            clearTimeout(poemDisplayTimeout);
            if (audioStarted) playWhoosh();
            switchScene('scene-poem', 'scene-garden');
        });

        function goToBouquet() {
            clearTimeout(poemDisplayTimeout);
            if (audioStarted) playWhoosh();
            switchScene('scene-poem', 'scene-bouquet');
            setTimeout(initBouquetScene, 100);
        }

        document.getElementById('bouquet-button').addEventListener('click', () => {
            if (audioStarted) playBloom();
            switchScene('scene-bouquet', 'scene-proposal');
        });

        document.getElementById('yesButton').addEventListener('click', () => {
            if (audioStarted) {
                playChime();
                playHeartbeat();
            }
            document.getElementById('yesButton').classList.add('shake');
            setTimeout(() => {
                switchScene('scene-proposal', 'scene-result');
                setTimeout(initResultScene, 100);
            }, 400);
        });

        let noButtonClickCount = 0;
        document.getElementById('noButton').addEventListener('click', (e) => {
            if (noButtonClickCount < 2) {
                const randomX = (Math.random() - 0.5) * 250;
                const randomY = (Math.random() - 0.5) * 150;
                e.target.style.transform = `translate(${randomX}px, ${randomY}px)`;
                noButtonClickCount++;
            } else {
                if (audioStarted) playWhoosh();
                switchScene('scene-proposal', 'scene-result');
                setTimeout(initResultScene, 100);
            }
        });

        const audioOverlay = document.getElementById('audioOverlay');
        function enableAudio() {
            const started = initAudio();
            if (started) {
                playAmbientMusic();
                playHeartbeatLoop();
                audioOverlay.classList.remove('show');
            }
        }

        audioOverlay.addEventListener('click', enableAudio);
        audioOverlay.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                enableAudio();
            }
        });

        function handleFirstInteraction() {
            if (!audioContext) {
                try {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    ctx.close();
                    initAudio();
                } catch (e) {
                    audioOverlay.classList.add('show');
                }
            }
            document.removeEventListener('click', handleFirstInteraction);
            document.removeEventListener('touchstart', handleFirstInteraction);
        }

        document.addEventListener('click', handleFirstInteraction);
        document.addEventListener('touchstart', handleFirstInteraction);

        window.addEventListener('load', () => {
            setTimeout(initIntroScene, 100);
        });

        document.body.style.overflow = 'hidden';
        document.body.style.touchAction = 'none';
    </script>
</body>
</html>
