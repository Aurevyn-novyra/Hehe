<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Will you be my universe? â€” Proposal</title>
<meta name="description" content="Cinematic romantic proposal â€” single-file, ultra-smooth animations, realistic tulips, bouquet, and WebAudio effects.">
<style>
  /* --------------------------
     Visual tokens (cinematic)
     -------------------------- */
  :root{
    --bg-deep1: #060410;
    --bg-deep2: #14102a;
    --accent-pink: 332 90% 64%;
    --accent-rose: 325 85% 58%;
    --glass: rgba(255,255,255,0.06);
    --muted: rgba(255,255,255,0.78);
    --ui-radius:18px;
  }
  html,body{height:100%;margin:0;font-family:Georgia, 'Times New Roman', serif;background:
    radial-gradient(800px 400px at 15% 12%, rgba(85,12,70,0.12), transparent 10%),
    linear-gradient(180deg,var(--bg-deep1), var(--bg-deep2)); color:#fff; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; overflow:hidden}
  /* Canvas */
  canvas{position:fixed;inset:0;display:block;z-index:0}
  /* floating glass/prism layer */
  .prism{
    position:fixed;inset:-10%;z-index:5;pointer-events:none;
    background:linear-gradient(120deg, rgba(255,255,255,0.02), rgba(200,120,220,0.02));
    mix-blend-mode:screen; filter:blur(18px); transform:rotate(12deg);
    animation:prismMove 26s linear infinite;
  }
  @keyframes prismMove{0%{transform:translate(-6%,-6%) rotate(0)}50%{transform:translate(0,0) rotate(180deg)}100%{transform:translate(-6%,-6%) rotate(360deg)}}

  /* UI layer */
  .ui{position:fixed;inset:0;z-index:10;display:flex;align-items:center;justify-content:center;flex-direction:column;pointer-events:none}
  .card{pointer-events:auto; width:min(920px,92%); max-width:920px; padding:22px; border-radius:var(--ui-radius); background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); box-shadow:0 30px 120px rgba(2,6,23,0.65); text-align:center; backdrop-filter: blur(6px) saturate(1.05);}
  .lead{font-size:20px; color:var(--muted); margin-bottom:14px; letter-spacing:.2px}
  .glass-btn{pointer-events:auto;border:0;padding:16px 44px;border-radius:999px;font-weight:900;font-size:18px;background:linear-gradient(180deg,hsl(var(--accent-pink)),hsl(var(--accent-rose)));color:white;cursor:pointer;box-shadow:0 10px 50px rgba(255,80,170,0.12);transition:transform .28s cubic-bezier(.2,.9,.3,1), box-shadow .28s;outline:none}
  .glass-btn:active{transform:scale(.98)}
  .micro{font-size:13px;color:rgba(255,255,255,0.68);margin-top:10px}

  /* Tools */
  .tools{position:fixed;right:18px;top:18px;display:flex;gap:10px;z-index:15;pointer-events:auto}
  .tool-btn{padding:10px 14px;border-radius:12px;border:0;background:rgba(255,255,255,0.02);color:var(--muted);font-weight:800;cursor:pointer;box-shadow:0 8px 30px rgba(0,0,0,0.6)}

  /* Poem area */
  .poem-area{position:fixed;left:50%;transform:translateX(-50%);bottom:78px;z-index:15;pointer-events:auto;width:min(860px,94%);padding:18px;border-radius:12px;background:rgba(0,0,0,0.36);box-shadow:0 20px 60px rgba(2,6,23,0.5);display:none}
  .poem-line{opacity:0;transform:translateY(10px);transition:all .6s cubic-bezier(.2,.9,.3,1);font-size:18px;line-height:1.6;color:rgba(255,250,250,0.98);font-family:Georgia,serif}

  /* Bottom controls */
  .bottom-controls{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;z-index:18;display:flex;gap:12px;pointer-events:auto}
  .small-btn{padding:10px 14px;border-radius:10px;border:0;background:linear-gradient(180deg,#fff,#f3f3f3);font-weight:800;cursor:pointer}

  /* Modal */
  .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%) scale(.96);z-index:25;padding:20px;border-radius:14px;background:linear-gradient(180deg,#fff,#fff);color:#0b1112;box-shadow:0 40px 140px rgba(2,6,23,0.6);display:none;pointer-events:auto}
  .modal.show{display:block;animation:pop .42s cubic-bezier(.2,.9,.3,1) both}
  @keyframes pop{from{opacity:0;transform:translate(-50%,-50%) scale(.86)}to{opacity:1;transform:translate(-50%,-50%) scale(1)}}
  .modal h2{margin:0;font-size:22px;font-weight:900}
  .modal .row{display:flex;gap:12px;margin-top:14px;justify-content:center}

  /* responsive */
  @media (max-width:520px){
    .card{padding:16px;border-radius:12px}
    .poem-line{font-size:16px}
    .glass-btn{padding:14px 30px;font-size:16px}
  }

  /* reduced motion */
  @media (prefers-reduced-motion: reduce){
    .prism, .glass-btn, .tool-btn, .small-btn { animation:none !important; transition:none !important; }
  }
</style>
</head>
<body>

<!-- Canvas for stars, nebula, tulips, bouquet -->
<canvas id="canvas"></canvas>

<!-- Prism layer for soft color -->
<div class="prism" aria-hidden="true"></div>

<!-- UI -->
<div class="ui" aria-hidden="false">
  <div class="card" id="introCard" role="region" aria-label="Intro">
    <div class="lead">This isnâ€™t a normal websiteâ€¦</div>
    <button id="startBtn" class="glass-btn" aria-label="Tap to begin">Tap to Begin</button>
    <div class="micro">Tap to unlock â€¢ Mobile optimized â€¢ Cinematic</div>
  </div>
</div>

<!-- Tools -->
<div class="tools" id="tools" style="display:none">
  <button class="tool-btn" id="btnPoem">Continue</button>
  <button class="tool-btn" id="btnOneLast">One last thing...</button>
</div>

<!-- Poem area (hidden until used) -->
<div class="poem-area" id="poemArea" aria-live="polite"></div>

<!-- Modal -->
<div class="modal" id="proposalModal" role="dialog" aria-modal="true" aria-hidden="true">
  <h2>Will you be my universe? ðŸ’«</h2>
  <div style="color:rgba(0,0,0,0.58);margin-top:6px">Choose</div>
  <div class="row">
    <button class="glass-btn" id="yesBtn" style="background:linear-gradient(180deg,hsl(320 80% 70%), hsl(320 70% 60%));">YES</button>
    <button class="glass-btn" id="noBtn" style="background:linear-gradient(180deg,#111,#0b0b0d);">NO</button>
  </div>
</div>

<!-- Bottom controls -->
<div class="bottom-controls" id="bottomControls" style="display:none">
  <button class="small-btn" id="continueBtn">Continue</button>
  <button class="small-btn" id="resetBtn">Reset</button>
</div>

<!-- sound permission overlay -->
<div id="soundOverlay" style="display:none;position:fixed;inset:0;z-index:40;align-items:center;justify-content:center;background:rgba(2,6,10,0.6);pointer-events:auto">
  <div style="background:linear-gradient(180deg,#081221,#0f2630);padding:18px;border-radius:12px;color:#fff;text-align:center;box-shadow:0 30px 100px rgba(0,0,0,0.7)">
    <div style="font-weight:800;font-size:18px">Enable sound</div>
    <div style="color:rgba(255,255,255,0.75);margin-top:8px">Tap to allow cinematic music & effects</div>
    <button id="allowSound" class="glass-btn" style="margin-top:12px">Enable sound</button>
  </div>
</div>

<!-- small credit -->
<div style="position:fixed;left:10px;bottom:8px;color:rgba(255,255,255,0.08);font-size:12px;z-index:5">single-file â€¢ premium proposal</div>

<script>
/* ============================================================================
   Ultra-premium single-file site
   - Scenes: intro -> garden -> poem -> bouquet -> proposal -> result
   - Canvas renders: stars, nebula, tulip field, bouquet assembly, petals
   - WebAudio synthesizes ambient pad, whoosh, heartbeat and chime
   - Touch & keyboard friendly, reduced-motion aware, auto-advance fallbacks
   ============================================================================ */

(() => {
  'use strict';

  /* --------------------------
     Config
     -------------------------- */
  const AUTO_ADVANCE_MS = 10000;   // fallback auto-advance when user idle
  const POEM_PAUSE_MS = 2000;     // pause between poem chunks (two lines)
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d', { alpha: true });
  let DPR = Math.max(1, window.devicePixelRatio || 1);

  // DOM refs
  const startBtn = document.getElementById('startBtn');
  const introCard = document.getElementById('introCard');
  const tools = document.getElementById('tools');
  const btnPoem = document.getElementById('btnPoem');
  const btnOneLast = document.getElementById('btnOneLast');
  const poemArea = document.getElementById('poemArea');
  const bottomControls = document.getElementById('bottomControls');
  const continueBtn = document.getElementById('continueBtn');
  const resetBtn = document.getElementById('resetBtn');
  const proposalModal = document.getElementById('proposalModal');
  const yesBtn = document.getElementById('yesBtn');
  const noBtn = document.getElementById('noBtn');
  const soundOverlay = document.getElementById('soundOverlay');
  const allowSound = document.getElementById('allowSound');

  // exact poem (unchanged)
  const POEM_LINES = [
"Sometimes I think I fell for you",
"before I even learned how falling works.",
"My words trip over themselves..",
"And as I said earlier.. you're like a Luminous Singularity",
"which's parallel yet coincidently intersecting...",
"Like constellations shuffled in a hurry...",
"Orion losing its belt..",
"Cassiopeia sitting upside down..",
"and whole sky is asking \"Why is she the only one shining this bright?\"",
"And I swear ... ",
"every time i try to explain what you mean to me.. I fumble..I'm scared...",
"and my heart chooses Your tulips instead of sentences ",
"petals arranged in a wrong order.. yet beautiful..",
"Colors mixing where they shouldn't yet somehow looking eternal..",
"and it's strange how You make the universe feel like a misprinted bouquet..",
"Galaxies scribbled over with your name..",
"planets orbiting a little too close..",
"a pull like the Black hole..",
"Like they too forgot their distance.",
"And me? I'm jst a boy holding a bouquet thinking maybe if I say it wrong enough times",
"you Might hear the truth hidden between the mistakes",
"That in every star's cold shimmer and every tulip's quite softness",
"i keep finding you ",
"not perfectly..",
"not clearly ",
"but completely..."
];

  /* --------------------------
     Canvas sizing
     -------------------------- */
  function resize(){ DPR = Math.max(1, window.devicePixelRatio || 1); canvas.width = Math.floor(innerWidth * DPR); canvas.height = Math.floor(innerHeight * DPR); canvas.style.width = innerWidth + 'px'; canvas.style.height = innerHeight + 'px'; ctx.setTransform(DPR,0,0,DPR,0,0); }
  addEventListener('resize', resize);
  resize();

  /* --------------------------
     Utilities
     -------------------------- */
  const rand = (a,b) => a + Math.random()*(b-a);
  const clamp = (v,a,b) => Math.max(a, Math.min(b, v));
  const easeOutCubic = t => 1 - Math.pow(1-t,3);
  const reducedMotion = matchMedia('(prefers-reduced-motion: reduce)').matches;

  /* --------------------------
     Scene & animation state
     -------------------------- */
  let raf = null, last = 0;
  let stars = [], nebula = [], tulips = [], particles = [];
  let bouquetMode = false, bouquetFormed = false, poemInProgress = false;
  let poemIndex = 0;
  let autoTimers = [];

  function clearAutoTimers(){ autoTimers.forEach(t=>clearTimeout(t)); autoTimers=[]; }

  /* --------------------------
     WebAudio synth (ambient + whoosh + heartbeat + chime)
     -------------------------- */
  let audio = null;
  function initAudio(){
    try{
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const ac = new AudioCtx();
      const master = ac.createGain(); master.gain.value = 0.0; master.connect(ac.destination);

      // ambient pad: layered oscillators
      const padGain = ac.createGain(); padGain.gain.value = 0.0; padGain.connect(master);
      const padFilter = ac.createBiquadFilter(); padFilter.type='lowpass'; padFilter.frequency.value = 1200; padFilter.Q.value = 0.7; padFilter.connect(padGain);
      const freqs = [220, 278.5, 330];
      const padNodes = freqs.map((f,i)=> {
        const o = ac.createOscillator(); o.type = i===1 ? 'sine' : 'triangle'; o.frequency.value = f;
        const g = ac.createGain(); g.gain.value = 0.0;
        o.connect(g); g.connect(padFilter);
        const lfo = ac.createOscillator(); lfo.type='sine'; lfo.frequency.value = 0.06 + i*0.01;
        const lfoG = ac.createGain(); lfoG.gain.value = 0.06;
        lfo.connect(lfoG); lfoG.connect(g.gain);
        o.start(); lfo.start();
        return {o,g,lfo,lfoG};
      });

      function startAmbient(){
        padNodes.forEach((n,i)=>{
          n.gain.gain.cancelScheduledValues(ac.currentTime);
          n.gain.gain.setValueAtTime(0, ac.currentTime);
          n.gain.gain.linearRampToValueAtTime(0.05/(i+0.6), ac.currentTime + 1.6);
        });
        master.gain.cancelScheduledValues(ac.currentTime);
        master.gain.setValueAtTime(0, ac.currentTime);
        master.gain.linearRampToValueAtTime(1.0, ac.currentTime + 1.6);
      }

      function heartbeat(){
        const t0 = ac.currentTime;
        const o = ac.createOscillator(); o.type='sine'; o.frequency.value=60;
        const g = ac.createGain(); g.gain.value=0;
        const f = ac.createBiquadFilter(); f.type='lowpass'; f.frequency.value=220;
        o.connect(f); f.connect(g); g.connect(master);
        o.start();
        g.gain.setValueAtTime(0, t0);
        g.gain.linearRampToValueAtTime(0.7, t0+0.01);
        g.gain.exponentialRampToValueAtTime(0.001, t0+0.5);
        o.stop(t0+0.6);
      }

      function whoosh(duration=0.45, freq=1200){
        const bufferSize = ac.sampleRate * duration;
        const noiseBuffer = ac.createBuffer(1, bufferSize, ac.sampleRate);
        const out = noiseBuffer.getChannelData(0);
        for(let i=0;i<bufferSize;i++) out[i] = (Math.random()*2-1) * Math.pow(1 - i/bufferSize, 1.6);
        const src = ac.createBufferSource(); src.buffer = noiseBuffer;
        const f = ac.createBiquadFilter(); f.type='bandpass'; f.frequency.value = freq; f.Q.value=0.8;
        const g = ac.createGain(); g.gain.value = 0.85;
        src.connect(f); f.connect(g); g.connect(master);
        src.start();
      }

      function chime(){
        const t0 = ac.currentTime;
        const notes = [880, 1320, 1760];
        notes.forEach((n,i)=>{
          const o = ac.createOscillator(); o.type='triangle'; o.frequency.value = n;
          const g = ac.createGain(); g.gain.value = 0;
          o.connect(g); g.connect(master);
          const delay = 0.02 * i;
          o.start(t0 + delay);
          g.gain.setValueAtTime(0, t0 + delay);
          g.gain.linearRampToValueAtTime(0.14, t0 + delay + 0.02);
          g.gain.exponentialRampToValueAtTime(0.001, t0 + delay + 1.2);
          o.stop(t0 + delay + 1.3);
        });
      }

      audio = { ac, master, startAmbient, heartbeat, whoosh, chime };
      return true;
    }catch(e){
      console.warn('Audio init failed', e);
      audio = null;
      return false;
    }
  }

  function ensureAudioOnGesture(){
    if (!audio) initAudio();
    try { if (audio) audio.startAmbient(); } catch(e){}
  }

  /* --------------------------
     Visual primitives & init
     -------------------------- */
  function initScene(){
    // stars
    stars = [];
    const sc = Math.round(clamp(window.innerWidth / 6, 40, 220));
    for(let i=0;i<sc;i++){
      stars.push({ x: Math.random()*innerWidth, y: Math.random()*innerHeight*0.55, r: Math.random()*1.6 + 0.3, tw: Math.random()*Math.PI*2, speed: 0.0006 + Math.random()*0.0024, bright: 0.4 + Math.random()*0.9 });
    }
    // nebula soft blobs
    nebula = [];
    for(let i=0;i<4;i++){
      nebula.push({ x: Math.random()*innerWidth, y: Math.random()*innerHeight*0.45, r: rand(innerWidth*0.25, innerWidth*0.6), hue: rand(260,340), a: 0.06 + Math.random()*0.12 });
    }
    // tulip field (layered rows for depth)
    tulips = [];
    const rows = Math.round(clamp(window.innerHeight / 26, 6, 14));
    for(let row=0; row<rows; row++){
      const depth = row / rows; // 0 front, 1 back
      const count = Math.round(clamp(8 + (1-depth)*18, 6, 28));
      const y = window.innerHeight - (row * (window.innerHeight/(rows*1.12))) - 30;
      for(let i=0;i<count;i++){
        const x = rand(36, window.innerWidth -36);
        const s = 0.6 + (1 - depth) * 1.25 + rand(-0.06,0.06);
        const hue = rand(320,350);
        tulips.push(new Tulip(x, y + rand(-8,8), s, hue, depth));
      }
    }
    tulips.sort((a,b)=> a.y - b.y);
    particles = [];
    bouquetMode = false; bouquetFormed = false; poemInProgress = false; poemIndex = 0;
  }

  /* Tulip class (layered petals via bezier + gradients) */
  function Tulip(x,y,scale,hue,depth){
    this.x = x; this.y = y; this.baseY = y; this.scale = scale; this.hue = hue; this.depth = depth;
    this.growth = rand(0.3, 1.0);
    this.swing = rand(0, Math.PI*2);
    this.inBouquet = false; this.target = null;
  }
  Tulip.prototype.update = function(dt){
    if (this.growth < 1) this.growth = Math.min(1, this.growth + dt*0.5);
    this.swing += dt*0.6 + this.depth*0.01;
    this._sway = Math.sin(this.swing) * 6 * this.scale * (1.1 - this.depth);
    if (this.inBouquet && this.target){
      this.x += (this.target.x - this.x) * clamp(dt*6, 0, 1);
      this.y += (this.target.y - this.y) * clamp(dt*6, 0, 1);
    } else {
      // micro movement for life
      this.x += Math.sin(this.swing*0.5) * 0.02;
    }
  }
  Tulip.prototype.draw = function(ctx){
    ctx.save();
    // shadow
    ctx.beginPath();
    ctx.ellipse(this.x, this.baseY + 6*this.scale, 12*this.scale*(1 + (1-this.depth)*0.6), 3*this.scale, 0, 0, Math.PI*2);
    ctx.fillStyle = 'rgba(6,8,10,0.14)'; ctx.fill();

    // stem
    const stemLen = 72*this.scale*(0.45 + this.growth*0.95);
    ctx.beginPath(); ctx.moveTo(this.x, this.baseY);
    ctx.quadraticCurveTo(this.x - 8*this.scale + this._sway*0.18, this.baseY - stemLen*0.42, this.x + this._sway*0.4, this.baseY - stemLen);
    ctx.lineWidth = 3*this.scale; ctx.strokeStyle = 'hsl(140 45% 22%)'; ctx.lineCap = 'round'; ctx.stroke();

    // leaf
    ctx.beginPath(); ctx.moveTo(this.x - 6*this.scale, this.baseY - stemLen*0.45);
    ctx.quadraticCurveTo(this.x - 36*this.scale, this.baseY - stemLen*0.62, this.x - 6*this.scale, this.baseY - stemLen*0.12);
    ctx.fillStyle = 'rgba(18,90,62,0.86)'; ctx.fill();

    // petals layered
    const petalY = this.baseY - stemLen;
    const petalScale = 1.0 * this.scale;
    for (let i=0;i<3;i++){
      ctx.save();
      ctx.translate(this.x + this._sway*0.4, petalY);
      ctx.rotate((i-1)*0.55 + (1-this.growth)*0.12);
      const g = ctx.createLinearGradient(-18*petalScale,-10*petalScale,18*petalScale,30*petalScale);
      g.addColorStop(0, `hsl(${this.hue} 92% ${58 - i*2}%)`);
      g.addColorStop(0.6, `hsl(${this.hue-12} 74% ${40}%)`);
      g.addColorStop(1, 'rgba(8,6,6,0.08)');
      ctx.fillStyle = g;
      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.bezierCurveTo(8*petalScale,-8*petalScale,22*petalScale,-6*petalScale,18*petalScale,18*petalScale);
      ctx.bezierCurveTo(6*petalScale,36*petalScale,-8*petalScale,28*petalScale,-8*petalScale,12*petalScale);
      ctx.closePath(); ctx.fill();
      ctx.beginPath(); ctx.moveTo(0,2*petalScale); ctx.quadraticCurveTo(6*petalScale,-2*petalScale,10*petalScale,18*petalScale);
      ctx.strokeStyle = 'rgba(255,255,255,0.06)'; ctx.lineWidth = 0.8; ctx.stroke();
      ctx.restore();
    }
    // center
    ctx.beginPath(); ctx.arc(this.x + this._sway*0.4, petalY + 6*petalScale, 3*petalScale, 0, Math.PI*2); ctx.fillStyle='rgba(28,12,16,0.92)'; ctx.fill();
    ctx.restore();
  }

  /* Particle (petal/confetti) */
  function Particle(x,y,vx,vy,life,color,size){
    this.x=x; this.y=y; this.vx=vx; this.vy=vy; this.life=life; this.maxLife=life; this.color=color; this.size=size;
  }
  Particle.prototype.update = function(dt){
    this.life -= dt;
    this.x += this.vx * dt * 60;
    this.y += this.vy * dt * 60;
    this.vy += 0.03;
  }
  Particle.prototype.draw = function(ctx){
    if (this.life <= 0) return;
    const t = Math.max(0, this.life / this.maxLife);
    ctx.globalAlpha = Math.pow(t, 0.95);
    ctx.beginPath();
    ctx.ellipse(this.x, this.y, this.size, this.size*0.72, Math.PI*0.18, 0, Math.PI*2);
    ctx.fillStyle = this.color;
    ctx.fill();
    ctx.globalAlpha = 1;
  }

  /* --------------------------
     Render loop
     -------------------------- */
  function render(ts){
    if (!last) last = ts;
    const dt = Math.min(0.04, (ts - last)/1000);
    last = ts;

    // clear
    ctx.clearRect(0,0,canvas.width/DPR, canvas.height/DPR);

    // background gradient
    const g = ctx.createLinearGradient(0,0,0,innerHeight);
    g.addColorStop(0, 'rgba(6,6,12,0.14)');
    g.addColorStop(1, 'rgba(2,4,8,0.98)');
    ctx.fillStyle = g; ctx.fillRect(0,0,innerWidth,innerHeight);

    // nebula soft blobs
    nebula.forEach(n=>{
      ctx.save(); ctx.globalCompositeOperation = 'lighter';
      const rg = ctx.createRadialGradient(n.x, n.y, n.r*0.02, n.x, n.y, n.r);
      rg.addColorStop(0, `hsla(${n.hue},80%,70%,${n.a})`);
      rg.addColorStop(1, 'rgba(6,6,12,0)');
      ctx.fillStyle = rg; ctx.beginPath(); ctx.ellipse(n.x, n.y, n.r, n.r*0.6, 0, 0, Math.PI*2); ctx.fill();
      ctx.restore();
    });

    // stars
    const tscale = ts * 0.001;
    stars.forEach(s=>{
      const alpha = Math.max(0.12, Math.min(1, s.bright * (0.6 + 0.4*Math.sin(s.tw + tscale*s.speed*120))));
      ctx.beginPath(); ctx.fillStyle = `rgba(255,255,255,${alpha})`; ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); ctx.fill();
      s.tw += s.speed * 0.8;
    });

    // ground
    const gh = 160; const gy = innerHeight - gh;
    const gg = ctx.createLinearGradient(0,gy,0,innerHeight); gg.addColorStop(0,'rgba(6,18,16,0.9)'); gg.addColorStop(1,'rgba(2,6,6,0.98)');
    ctx.fillStyle = gg; ctx.fillRect(0, gy, innerWidth, gh + 40);

    // draw tulips
    tulips.sort((a,b)=>a.y - b.y);
    for (let t of tulips){ try { t.update(dt); t.draw(ctx); } catch(e){ console.warn(e); } }

    // particles
    for (let i=particles.length-1;i>=0;i--){
      const p = particles[i]; p.update(dt); if (p.life <= 0) particles.splice(i,1); else p.draw(ctx);
    }

    // bouquet glow
    if (bouquetFormed){
      const cx = innerWidth/2, cy = innerHeight/2;
      const rg = ctx.createRadialGradient(cx, cy, 10, cx, cy, 420);
      rg.addColorStop(0, 'rgba(255,210,240,0.12)'); rg.addColorStop(1, 'rgba(0,0,0,0)');
      ctx.fillStyle = rg; ctx.fillRect(0,0,innerWidth,innerHeight);
      if (Math.random() < 0.66) spawnPetal(cx + rand(-60,60), cy - rand(0,60));
    }

    raf = requestAnimationFrame(render);
  }

  /* --------------------------
     Spawning petals
     -------------------------- */
  function spawnPetal(x,y,color){
    particles.push(new Particle(x,y, rand(-0.6,0.6), rand(-0.6,0.8), rand(1.8,4.2), color || `hsl(${rand(320,350)} 88% ${rand(54,68)}%)`, rand(3.5,7)));
    if (particles.length > 900) particles.splice(0, particles.length - 900);
  }

  /* --------------------------
     Bouquet formation
     -------------------------- */
  function formBouquet(){
    if (bouquetMode) return;
    bouquetMode = true;
    const cx = innerWidth/2, cy = innerHeight/2 + 6;
    const sorted = tulips.slice().sort((a,b)=> (Math.hypot(a.x-cx,a.y-cy) - Math.hypot(b.x-cx,b.y-cy)));
    const pick = sorted.slice(0,10);
    pick.forEach((t,i)=>{
      t.inBouquet = true;
      const angle = (i / pick.length) * Math.PI*2;
      const r = 22 + (i%3)*6;
      t.target = { x: cx + Math.cos(angle)*r + rand(-6,6), y: cy + Math.sin(angle)*(6 + (i%2)*8) + rand(-6,6) };
    });
    // ribbon-like particle wrap (visual)
    setTimeout(()=>{
      bouquetFormed = true;
      if (audio) { try { audio.whoosh(0.45, 1100); audio.chime(); } catch(e){} }
      setTimeout(()=> showProposalModal(), 900);
    }, 700);
  }

  /* --------------------------
     Poem reveal (2 lines at a time)
     -------------------------- */
  let poemTimer = null;
  function showPoem(){
    poemArea.innerHTML = ''; poemArea.style.display = 'block';
    poemInProgress = true; poemIndex = 0;
    revealPoemChunk();
  }
  function revealPoemChunk(){
    poemArea.innerHTML = '';
    for (let i=0;i<2;i++){
      const line = POEM_LINES[poemIndex + i] || '';
      const d = document.createElement('div'); d.className = 'poem-line'; d.textContent = line;
      poemArea.appendChild(d);
    }
    // trigger animation
    requestAnimationFrame(()=> {
      poemArea.querySelectorAll('.poem-line').forEach((n, idx) => {
        n.style.opacity = '1'; n.style.transform = 'translateY(0)';
      });
    });
    // audio + bloom
    if (audio) { try { audio.whoosh(0.02, 1200); } catch(e){} }
    const sample = tulips[Math.floor(Math.random()*tulips.length)]; if (sample) sample.growth = Math.min(1, sample.growth + 0.14);
    poemIndex += 2;
    if (poemIndex >= POEM_LINES.length){
      clearTimeout(poemTimer);
      // reveal next step tools
      setTimeout(()=> { tools.style.display = 'flex'; btnOneLast.animate([{transform:'scale(.98)'},{transform:'scale(1)'}],{duration:600,easing:'cubic-bezier(.2,.9,.3,1)'}); }, 900);
      return;
    }
    poemTimer = setTimeout(()=> revealPoemChunk(), POEM_PAUSE_MS + 400);
  }

  /* --------------------------
     Modal & interactions
     -------------------------- */
  function showProposalModal(){
    proposalModal.classList.add('show'); proposalModal.setAttribute('aria-hidden','false');
  }
  function hideProposalModal(){ proposalModal.classList.remove('show'); proposalModal.setAttribute('aria-hidden','true'); }

  function celebrateYes(){
    for (let i=0;i<260;i++) spawnPetal(rand(0,innerWidth), rand(-40, innerHeight*0.24));
    if (audio) { try { audio.chime(); audio.heartbeat(); } catch(e){} }
    poemArea.innerHTML = '<div style="text-align:center;font-weight:800;font-size:20px;color:#fff">You were always my favorite galaxy ðŸŒ™ðŸŒ·</div>';
    poemArea.style.display = 'block';
    hideProposalModal();
  }

  let noDodge = 0;
  function handleNo(){
    if (noDodge < 2){
      const tx = rand(-120,120), ty = rand(-40,40);
      noBtn.style.transform = `translate(${tx}px, ${ty}px)`;
      noDodge++;
      if (audio) try { audio.whoosh(0.03, 900); } catch(e){}
      setTimeout(()=> { noBtn.style.transform = 'translate(0,0)'; }, 820);
    } else {
      hideProposalModal();
      poemArea.innerHTML = '<div style="text-align:center;color:rgba(255,255,255,0.92)">Itâ€™s okay â€” take your time.</div>';
      poemArea.style.display = 'block';
    }
  }

  /* --------------------------
     Auto-advance safety
     -------------------------- */
  function safeAdvance(fn, t = AUTO_ADVANCE_MS){
    const id = setTimeout(()=> { try{ fn(); } catch(e){ console.warn(e); } }, t);
    autoTimers.push(id); return id;
  }

  /* --------------------------
     Event wiring (flow)
     -------------------------- */
  startBtn.addEventListener('click', (e) => {
    ensureAudioOnGesture();
    // cinematic dissolve burst
    for (let i=0;i<48;i++) spawnPetal(innerWidth/2 + rand(-32,32), innerHeight/2 + rand(-28,28), `hsl(${rand(320,350)} 88% ${rand(54,68)}%)`);
    if (audio) try { audio.whoosh(0.02, 1200); } catch(e){}
    // hide intro
    introCard.style.display = 'none';
    // show controls after small delay
    setTimeout(()=> { bottomControls.style.display = 'flex'; tools.style.display = 'flex'; btnPoem.focus(); /* nudge tulips growth */ tulips.forEach(t=> t.growth = Math.min(1, t.growth + 0.24)); }, 420);
    // ensure render running
    if (!raf) raf = requestAnimationFrame(render);
    // auto show poem UI if idle
    safeAdvance(()=> { if (!poemInProgress) showPoem(); }, AUTO_ADVANCE_MS);
  }, { once:true });

  btnPoem.addEventListener('click', ()=> {
    if (!poemInProgress) showPoem(); else revealPoemChunk();
  });

  continueBtn.addEventListener('click', ()=> {
    if (!poemInProgress) showPoem(); else revealPoemChunk();
  });

  btnOneLast.addEventListener('click', ()=> {
    formBouquet();
  });

  resetBtn.addEventListener('click', ()=> {
    clearAutoTimers();
    poemArea.style.display='none'; tools.style.display='none'; bottomControls.style.display='none';
    introCard.style.display='flex'; proposalModal.classList.remove('show');
    initScene();
  });

  yesBtn.addEventListener('click', ()=> celebrateYes());
  noBtn.addEventListener('click', ()=> handleNo());

  // canvas click on bouquet area to open modal
  canvas.addEventListener('click', (ev)=> {
    if (!bouquetFormed) return;
    const dx = ev.clientX - innerWidth/2, dy = ev.clientY - innerHeight/2;
    if (Math.hypot(dx,dy) < 140) {
      showProposalModal();
      if (audio) try { audio.whoosh(0.02, 1200); } catch(e){}
    }
  });

  // sound overlay enable
  allowSound.addEventListener('click', ()=> {
    initAudio();
    if (audio) { try { audio.startAmbient(); } catch(e){} }
    soundOverlay.style.display = 'none';
  });

  // keyboard accessibility: Enter activates focused button
  document.addEventListener('keydown', (e)=> {
    if ((e.key === 'Enter' || e.key === ' ') && document.activeElement){
      document.activeElement.click();
    }
  });

  /* --------------------------
     initialize & start
     -------------------------- */
  try {
    initScene();
    raf = requestAnimationFrame(render);
  } catch (err) {
    console.error('Init error:', err);
    // fallback: show UI so user can continue
    introCard.style.display = 'flex';
    tools.style.display = 'flex';
    bottomControls.style.display = 'flex';
  }

  // ensure audio allowed via first gesture if needed
  document.addEventListener('pointerdown', function once(){ document.removeEventListener('pointerdown', once); });

})();
</script>
</body>
</html>
